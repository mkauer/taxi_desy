(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","d3","threejs","threejs_all"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");a(b,require("./d3.min.js"),require("./three.min.js"),require("./three.extra.min.js"),b.nodejs||(typeof document=="undefined")?b.nodejs_document:document)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRoot3DPainter.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.js","JSRoot3DPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(JSROOT,d3,THREE)}}}(function(c,d,e,b,a){c.sources.push("3d");if((typeof a=="undefined")&&(typeof window=="object")){a=window.document}if(typeof c.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRoot3DPainter.js")}c.Painter.TestWebGL=function(){if(c.gStyle.NoWebGL){return false}if("_Detect_WebGL" in this){return this._Detect_WebGL}try{var f=a.createElement("canvas");this._Detect_WebGL=!!(window.WebGLRenderingContext&&(f.getContext("webgl")||f.getContext("experimental-webgl")))}catch(g){return false}return this._Detect_WebGL};c.Painter.TooltipFor3D=function(g,f){this.tt=null;this.cont=null;this.lastlbl="";this.parent=g?g:a.body;this.canvas=f;this.abspos=!g;this.check_parent=function(h){if(h&&(this.parent!==h)){this.hide();this.parent=h}};this.pos=function(p){if(this.tt===null){return}var n,j;if(this.abspos){j=c.browser.isIE?(p.clientX+a.documentElement.scrollLeft):p.pageX;n=c.browser.isIE?(p.clientY+a.documentElement.scrollTop):p.pageY}else{j=p.offsetX;n=p.offsetY;var k=this.parent.getBoundingClientRect(),i=this.canvas.getBoundingClientRect();if((k.left!==undefined)&&(i.left!==undefined)){j+=(i.left-k.left)}if((k.top!==undefined)&&(i.top!==undefined)){n+=i.top-k.top}if(j+this.tt.offsetWidth+3>=this.parent.offsetWidth){j=this.parent.offsetWidth-this.tt.offsetWidth-3}if(n+this.tt.offsetHeight+15>=this.parent.offsetHeight){n=this.parent.offsetHeight-this.tt.offsetHeight-15}var h=this.parent;while(h){var o=getComputedStyle(h);if(!o||(o.position!=="static")){break}if(!h.parentNode||(h.parentNode.nodeType!=1)){break}h=h.parentNode}if(h&&(h!==this.parent)){var m=h.getBoundingClientRect();j+=(k.left-m.left);n+=(k.top-m.top)}}this.tt.style.top=(n+15)+"px";this.tt.style.left=(j+3)+"px"};this.show=function(h,j,k){if(!h||(h==="")){return this.hide()}if(h&&(typeof h=="object")&&(h.lines||h.line)){if(h.only_status){return this.hide()}if(h.line){h=h.line}else{var i=h.lines[0];for(var l=1;l<h.lines.length;++l){i+="<br/>"+h.lines[l]}h=i}}if(this.tt===null){this.tt=a.createElement("div");this.tt.setAttribute("class","jsroot_tt3d_main");this.cont=a.createElement("div");this.cont.setAttribute("class","jsroot_tt3d_cont");this.tt.appendChild(this.cont);this.parent.appendChild(this.tt)}if(this.lastlbl!==h){this.cont.innerHTML=h;this.lastlbl=h;this.tt.style.width="auto";if(c.browser.isIE){this.tt.style.width=this.tt.offsetWidth}}};this.hide=function(){if(this.tt!==null){this.parent.removeChild(this.tt)}this.tt=null;this.lastlbl=""};return this};c.Painter.CreateOrbitControl=function(m,k,i,l,n){if(c.gStyle.Zooming&&c.gStyle.ZoomWheel){l.domElement.addEventListener("wheel",g)}if(c.gStyle.Zooming&&c.gStyle.ZoomMouse){l.domElement.addEventListener("mousedown",f);l.domElement.addEventListener("mouseup",j)}var h=new e.OrbitControls(k,l.domElement);h.enableDamping=false;h.dampingFactor=1;h.enableZoom=true;if(n){h.target.copy(n);h.target0.copy(n);h.update()}h.tooltip=new c.Painter.TooltipFor3D(m.select_main().node(),l.domElement);h.painter=m;h.camera=k;h.scene=i;h.renderer=l;h.raycaster=new e.Raycaster();h.raycaster.linePrecision=10;h.mouse_zoom_mesh=null;h.block_ctxt=false;h.block_mousemove=false;h.cursor_changed=false;h.control_changed=false;h.control_active=false;h.mouse_ctxt={x:0,y:0,on:false};h.Cleanup=function(){if(c.gStyle.Zooming&&c.gStyle.ZoomWheel){this.domElement.removeEventListener("wheel",g)}if(c.gStyle.Zooming&&c.gStyle.ZoomMouse){this.domElement.removeEventListener("mousedown",f);this.domElement.removeEventListener("mouseup",j)}this.domElement.removeEventListener("dblclick",this.lstn_dblclick);this.domElement.removeEventListener("contextmenu",this.lstn_contextmenu);this.domElement.removeEventListener("mousemove",this.lstn_mousemove);this.domElement.removeEventListener("mouseleave",this.lstn_mouseleave);this.dispose();this.tooltip.hide();delete this.tooltip;delete this.painter;delete this.camera;delete this.scene;delete this.renderer;delete this.raycaster;delete this.mouse_zoom_mesh};h.HideTooltip=function(){this.tooltip.hide()};h.GetMousePos=function(p,o){o.x=("offsetX" in p)?p.offsetX:p.layerX;o.y=("offsetY" in p)?p.offsetY:p.layerY;o.clientX=p.clientX;o.clientY=p.clientY;return o};h.GetIntersects=function(o){var r=(this.renderer instanceof e.WebGLRenderer)?this.renderer.getSize():this.renderer.domElement;var q={x:o.x/r.width*2-1,y:-o.y/r.height*2+1};this.camera.updateMatrix();this.camera.updateMatrixWorld();this.raycaster.setFromCamera(q,this.camera);var p=this.raycaster.intersectObjects(this.scene.children,true);if(typeof this.painter.FilterIntersects=="function"){p=this.painter.FilterIntersects(p)}return p};h.DetectZoomMesh=function(r){var o=this.GetMousePos(r,{});var p=this.GetIntersects(o);if(p){for(var q=0;q<p.length;++q){if(p[q].object.zoom){return p[q]}}}return null};h.ProcessDblClick=function(p){var o=this.DetectZoomMesh(p);if(o&&this.painter){this.painter.Unzoom(o.object.use_y_for_z?"y":o.object.zoom)}else{this.reset()}};h.ChangeEvent=function(){this.mouse_ctxt.on=false;this.painter.Render3D(0);this.control_changed=true};h.StartEvent=function(){this.control_active=true;this.block_ctxt=false;this.mouse_ctxt.on=false;this.tooltip.hide()};h.EndEvent=function(){this.control_active=false;if(this.mouse_ctxt.on){this.mouse_ctxt.on=false;this.ContextMenu(this.mouse_ctxt,this.GetIntersects(this.mouse_ctxt))}else{if(this.control_changed){}}this.control_changed=false};h.MainProcessContextMenu=function(o){o.preventDefault();this.GetMousePos(o,this.mouse_ctxt);if(this.control_active){this.mouse_ctxt.on=true}else{if(this.block_ctxt){this.block_ctxt=false}else{this.ContextMenu(this.mouse_ctxt,this.GetIntersects(this.mouse_ctxt))}}};h.ContextMenu=function(p,o){};h.SwitchTooltip=function(o){this.block_mousemove=!o;if(o===false){this.tooltip.hide();this.RemoveZoomMesh()}};h.RemoveZoomMesh=function(){if(this.mouse_zoom_mesh&&this.mouse_zoom_mesh.object.ShowSelection()){this.painter.Render3D()}this.mouse_zoom_mesh=null};h.MainProcessMouseMove=function(z){if(this.control_active&&z.buttons&&(z.buttons&2)){this.block_ctxt=true}if(this.control_active||this.block_mousemove||!this.ProcessMouseMove){return}if(this.mouse_zoom_mesh){var t=this.DetectZoomMesh(z),p=null;if(t&&(t.object===this.mouse_zoom_mesh.object)){p=t.point}else{p=this.mouse_zoom_mesh.object.GlobalIntersect(this.raycaster)}if(p){this.mouse_zoom_mesh.point2=p}if(p&&this.painter.enable_hightlight){if(this.mouse_zoom_mesh.object.ShowSelection(this.mouse_zoom_mesh.point,p)){this.painter.Render3D(0)}}this.tooltip.hide();return}z.preventDefault();var w=this.GetMousePos(z,{}),v=this.GetIntersects(w),y=this.ProcessMouseMove(v),s=this.painter.GetShowStatusFunc();if(y&&s){var o="",x="",u="",r="";if(w){u=w.x.toFixed(0)+","+w.y.toFixed(0)}if(typeof y=="string"){r=y}else{o=y.name;x=y.title;if(y.line){r=y.line}else{if(y.lines){r=y.lines.slice(1).join(" ");o=y.lines[0]}}}s(o,x,r,u)}this.cursor_changed=false;if(y&&this.painter.tooltip_allowed){this.tooltip.check_parent(this.painter.select_main().node());this.tooltip.show(y,w);this.tooltip.pos(z)}else{this.tooltip.hide();if(v){for(var q=0;q<v.length;++q){if(v[q].object.zoom){this.cursor_changed=true}}}}a.body.style.cursor=this.cursor_changed?"pointer":"auto"};h.MainProcessMouseLeave=function(){this.tooltip.hide();if(typeof this.ProcessMouseLeave==="function"){this.ProcessMouseLeave()}if(this.cursor_changed){a.body.style.cursor="auto";this.cursor_changed=false}};function g(s){if(c.Painter.IsRender3DFired(h.painter)||h.mouse_zoom_mesh){s.preventDefault();s.stopPropagation();s.stopImmediatePropagation();return}var p=h.DetectZoomMesh(s);if(!p){return}s.preventDefault();s.stopPropagation();s.stopImmediatePropagation();if(h.painter&&(h.painter.AnalyzeMouseWheelEvent!==undefined)){var q=p.object.zoom,o=p.point[q],r={name:q,ignore:false};if(q!=="z"){o=(o+h.painter.size_xy3d)/2/h.painter.size_xy3d}else{o=o/2/h.painter.size_z3d}h.painter.AnalyzeMouseWheelEvent(s,r,o,false);if((q==="z")&&p.object.use_y_for_z){q="y"}h.painter.Zoom(q,r.min,r.max)}}function f(o){if(h.mouse_zoom_mesh){o.stopImmediatePropagation();o.stopPropagation();return}if((o.button!==undefined)&&(o.button!==0)){return}if((o.buttons!==undefined)&&(o.buttons!==1)){return}h.mouse_zoom_mesh=h.DetectZoomMesh(o);if(!h.mouse_zoom_mesh){return}o.stopImmediatePropagation();o.stopPropagation()}function j(s){if(h.mouse_zoom_mesh&&h.mouse_zoom_mesh.point2&&h.painter.Get3DZoomCoord){var r=h.mouse_zoom_mesh.object.zoom,q=h.painter.Get3DZoomCoord(h.mouse_zoom_mesh.point,r),p=h.painter.Get3DZoomCoord(h.mouse_zoom_mesh.point2,r);if(q>p){var o=q;q=p;p=o}if((r==="z")&&h.mouse_zoom_mesh.object.use_y_for_z){r="y"}if((r==="z")&&h.mouse_zoom_mesh.object.use_y_for_z){r="y"}if(q<p){if(h.painter.Zoom(r,q,p)){h.mouse_zoom_mesh=null}}}h.RemoveZoomMesh()}h.MainProcessDblClick=function(o){this.ProcessDblClick(o)};h.addEventListener("change",h.ChangeEvent.bind(h));h.addEventListener("start",h.StartEvent.bind(h));h.addEventListener("end",h.EndEvent.bind(h));h.lstn_contextmenu=h.MainProcessContextMenu.bind(h);h.lstn_dblclick=h.MainProcessDblClick.bind(h);h.lstn_mousemove=h.MainProcessMouseMove.bind(h);h.lstn_mouseleave=h.MainProcessMouseLeave.bind(h);l.domElement.addEventListener("dblclick",h.lstn_dblclick);l.domElement.addEventListener("contextmenu",h.lstn_contextmenu);l.domElement.addEventListener("mousemove",h.lstn_mousemove);l.domElement.addEventListener("mouseleave",h.lstn_mouseleave);return h};c.Painter.DisposeThreejsObject=function(g,h){if(!g){return}if(g.children){for(var f=0;f<g.children.length;f++){c.Painter.DisposeThreejsObject(g.children[f])}}if(h){g.children=[];return}g.children=undefined;if(g.geometry){g.geometry.dispose();g.geometry=undefined}if(g.material){if(g.material.map){g.material.map.dispose();g.material.map=undefined}g.material.dispose();g.material=undefined}delete g.painter;delete g.bins_index;delete g.tooltip;delete g.stack;g=undefined};c.Painter.HPainter_Create3DScene=function(f){if((f!==undefined)&&(f<0)){if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(null,this.toplevel)}this.clear_3d_canvas();c.Painter.DisposeThreejsObject(this.scene);if(this.control){this.control.Cleanup()}if(this.renderer){if(this.renderer.dispose){this.renderer.dispose()}if(this.renderer.context){delete this.renderer.context}}delete this.size_xy3d;delete this.size_z3d;delete this.scene;delete this.toplevel;delete this.tooltip_mesh;delete this.camera;delete this.pointLight;delete this.renderer;delete this.control;if("render_tmout" in this){clearTimeout(this.render_tmout);delete this.render_tmout}return}if("toplevel" in this){this.scene.remove(this.toplevel);c.Painter.DisposeThreejsObject(this.toplevel);delete this.toplevel;delete this.tooltip_mesh;if(this.control){this.control.HideTooltip()}var i=new e.Object3D();this.scene.add(i);this.toplevel=i;this.Resize3D();return}this.usesvg=c.BatchMode;var k=this.size_for_3d(this.usesvg?3:undefined);this.size_z3d=100;this.size_xy3d=(k.height>10)&&(k.width>10)?Math.round(k.width/k.height*this.size_z3d):this.size_z3d;this.scene=new e.Scene();this.toplevel=new e.Object3D();this.scene.add(this.toplevel);this.scene_width=k.width;this.scene_height=k.height;this.camera=new e.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);var h=Math.max(0.75*this.size_xy3d,this.size_z3d);this.camera.position.set(-1.6*h,-3.5*h,1.4*this.size_z3d);this.pointLight=new e.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_xy3d/2,this.size_xy3d/2,this.size_z3d/2);var j=new e.Vector3(0,0,0.8*this.size_z3d);this.camera.up=new e.Vector3(0,0,1);this.camera.lookAt(j);this.scene.add(this.camera);if(this.usesvg){this.renderer=c.gStyle.SVGRenderer?new e.SVGRendererNew({antialias:true,alpha:true}):new e.SVGRenderer({antialias:true,alpha:true})}else{this.webgl=c.Painter.TestWebGL();this.renderer=this.webgl?new e.WebGLRenderer({antialias:true,alpha:true}):new e.CanvasRenderer({antialias:true,alpha:true})}this.renderer.setSize(this.scene_width,this.scene_height);this.add_3d_canvas(k,this.renderer.domElement);this.DrawXYZ=c.Painter.HPainter_DrawXYZ;this.Render3D=c.Painter.Render3D;this.Resize3D=c.Painter.Resize3D;this.BinHighlight3D=c.Painter.BinHighlight3D;this.first_render_tm=0;this.enable_hightlight=false;this.tooltip_allowed=(c.gStyle.Tooltip>0);if(c.BatchMode){return}this.control=c.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,j);var g=this;this.control.ProcessMouseMove=function(u){var v=null,w=null,n=null;for(var t=0;t<u.length;++t){if(u[t].object.tooltip){v=u[t].object.tooltip(u[t]);if(v){w=u[t].object;break}}else{if(u[t].object.zoom&&!n){n=u[t].object}}}if(v&&!v.use_itself){var o=0.0001*g.size_xy3d,p=0.0001*g.size_z3d;if((v.x1>v.x2)||(v.y1>v.y2)||(v.z1>v.z2)){console.warn("check 3D hints coordinates")}v.x1-=o;v.x2+=o;v.y1-=o;v.y2+=o;v.z1-=p;v.z2+=p}g.BinHighlight3D(v,w);if(!v&&n&&g.Get3DZoomCoord){var l=n.GlobalIntersect(this.raycaster),s=n.zoom,q=g.Get3DZoomCoord(l,s);if((s==="z")&&n.use_y_for_z){s="y"}var m=this.histo?this.histo["f"+s.toUpperCase()+"axis"]:null;var r={name:s,title:"TAxis",line:"any info",only_status:true};if(m){r.name=m.fName;r.title=m.fTitle||"histogram TAxis object"}r.line=s+" : "+g.AxisAsText(s,q);return r}return(v&&v.lines)?v:""};this.control.ProcessMouseLeave=function(){g.BinHighlight3D(null)};this.control.ContextMenu=function(s,m){var l="hist",o=g;if(m){for(var r=0;r<m.length;++r){var q=m[r].object;if(q.zoom){l=q.zoom;break}if(q.painter&&typeof q.painter.ShowContextMenu==="function"){o=q.painter;break}}}o.ShowContextMenu(l,s)}};c.Painter.HPainter_TestAxisVisibility=function(k,q,h,m){var p;for(var g=0;g<q.children.length;++g){p=q.children[g];if(p.axis_draw){break}p=undefined}if(!p){return}if(!k){q.remove(p);delete this.TestAxisVisibility;return}h=h?true:false;m=m?true:false;var l=1,o=k.position;if((o.x<0)&&(o.y>=0)){l=2}if((o.x>=0)&&(o.y>=0)){l=3}if((o.x>=0)&&(o.y<0)){l=4}function i(s,n){if(s<=l){s+=4}return(s>l)&&(s<l+n)}for(var g=0;g<p.children.length;++g){var r=p.children[g];if(r.grid){r.visible=m&&i(r.grid,3)}else{if(r.zid){r.visible=i(r.zid,2)}else{if(r.xyid){r.visible=i(r.xyid,3)}else{if(r.xyboxid){var j=5,f=0;if(m&&!h){j=3;f=-2}else{if(h&&!m){j=3}else{if(!h&&!m){j=(r.bottom?3:0)}}}r.visible=i(r.xyboxid+f,j);if(!r.visible&&r.bottom&&m){r.visible=i(r.xyboxid,3)}}else{if(r.zboxid){var j=2,f=0;if(h&&m){j=5}else{if(m&&!h){j=4}else{if(!m&&h){f=-2;j=4}}}r.visible=i(r.zboxid+f,j)}}}}}}};c.Painter.HPainter_DrawXYZ=function(A,L){if(!L){L={}}var G=-this.size_xy3d,k=this.size_xy3d,F=-this.size_xy3d,j=this.size_xy3d,D=0,g=2*this.size_z3d,Y=Math.round(this.size_z3d*0.05),B=this.root_pad(),z=this.histo,r=this.xmin,ab=this.xmax,V=this.ymin,l=this.ymax,h=this.zmin,M=this.zmax,s=false,x=false;if(!this.size_z3d){G=this.xmin;k=this.xmax;F=this.ymin;j=this.ymax;D=this.zmin;g=this.zmax;Y=(g-D)*0.05}if(("zoom_xmin" in this)&&("zoom_xmax" in this)&&(this.zoom_xmin!==this.zoom_xmax)){r=this.zoom_xmin;ab=this.zoom_xmax}if(("zoom_ymin" in this)&&("zoom_ymax" in this)&&(this.zoom_ymin!==this.zoom_ymax)){V=this.zoom_ymin;l=this.zoom_ymax;s=true}if(("zoom_zmin" in this)&&("zoom_zmax" in this)&&(this.zoom_zmin!==this.zoom_zmax)){h=this.zoom_zmin;M=this.zoom_zmax;x=true}if(L.use_y_for_z){this.zmin=this.ymin;this.zmax=this.ymax;h=V;M=l;x=s;V=0;l=1}this.lego_zmin=h;this.lego_zmax=M;if((L.zmult!==undefined)&&!x){M*=L.zmult}this.TestAxisVisibility=c.Painter.HPainter_TestAxisVisibility;if(B&&B.fLogx){if(ab<=0){ab=1}if((r<=0)&&(this.nbinsx>0)){for(var aj=0;aj<this.nbinsx;++aj){r=Math.max(r,this.GetBinX(aj));if(r>0){break}}}if(r<=0){r=0.0001*ab}this.grx=d.scaleLog();this.x_kind="log"}else{this.grx=d.scaleLinear();if(z&&z.fXaxis.fLabels){this.x_kind="labels"}else{this.x_kind="lin"}}this.logx=(this.x_kind==="log");this.grx.domain([r,ab]).range([G,k]);this.x_handle=new c.TAxisPainter(z?z.fXaxis:null);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.grx,this.xmin,this.xmax,r,ab);this.x_handle.CreateFormatFuncs();this.scale_xmin=r;this.scale_xmax=ab;if(B&&B.fLogy&&!L.use_y_for_z){if(l<=0){l=1}if((V<=0)&&(this.nbinsy>0)){for(var aj=0;aj<this.nbinsy;++aj){V=Math.max(V,this.GetBinY(aj));if(V>0){break}}}if(V<=0){V=0.0001*l}this.gry=d.scaleLog();this.y_kind="log"}else{this.gry=d.scaleLinear();if(z&&z.fYaxis.fLabels){this.y_kind="labels"}else{this.y_kind="lin"}}this.logy=(this.y_kind==="log");this.gry.domain([V,l]).range([F,j]);this.y_handle=new c.TAxisPainter(z?z.fYaxis:null);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.gry,this.ymin,this.ymax,V,l);this.y_handle.CreateFormatFuncs();this.scale_ymin=V;this.scale_ymax=l;if(B&&B.fLogz){if(M<=0){M=1}if(h<=0){h=0.0001*M}this.grz=d.scaleLog();this.z_kind="log"}else{this.grz=d.scaleLinear();this.z_kind="lin"}this.logz=(this.z_kind==="log");this.grz.domain([h,M]).range([D,g]);this.z_handle=new c.TAxisPainter(z?z.fZaxis:null);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.grz,this.zmin,this.zmax,h,M);this.z_handle.CreateFormatFuncs();this.scale_zmin=h;this.scale_zmax=M;var y=new e.MeshBasicMaterial({color:0}),t=new e.LineBasicMaterial({color:0}),Z=Y*0.5,N,f,K=[],H=1,X=this.x_handle.CreateTicks(),o=this.y_handle.CreateTicks(),aa=this.z_handle.CreateTicks();var m=new e.Object3D();m.axis_draw=true;A.add(m);var ad=[],al=0;while(X.next()){var U=X.grpos;var ah=(X.kind===1);var E=this.x_handle.format(X.tick,true,true);if(X.last_major()){E="x"}else{if(E===null){ah=false;E=""}}if(ah&&E&&(E.length>0)){var C=new e.TextGeometry(E,{font:c.threejs_font_helvetiker_regular,size:Y,height:0,curveSegments:5});C.computeBoundingBox();var v=C.boundingBox.max.x-C.boundingBox.min.x,u=C.boundingBox.max.y-C.boundingBox.min.y;C.translate(-v/2,0,0);al=Math.max(al,u);C.grx=U;K.push(C);if(!X.last_major()){var ak=(X.next_major_grpos()-U);if(v>0){H=Math.min(H,0.9*ak/v)}if(this.x_handle.IsCenterLabels()){C.grx+=ak/2}}}ad.push(U,0,0,U,(ah?-Z:-Z*0.6),0)}var ag=new e.BufferGeometry();ag.addAttribute("position",new e.BufferAttribute(new Float32Array(ad),3));this.Get3DZoomCoord=function(n,ao){var ap=n[ao],an=this["scale_"+ao+"min"],i=this["scale_"+ao+"max"];if(ao==="z"){ap=ap/2/this.size_z3d}else{ap=(ap+this.size_xy3d)/2/this.size_xy3d}if(this["log"+ao]){ap=Math.exp(Math.log(an)+ap*(Math.log(i)-Math.log(an)))}else{ap=an+ap*(i-an)}return ap};function ac(an,ao,aq){var i=new e.Geometry();if(an==="z"){i.vertices.push(new e.Vector3(0,0,0),new e.Vector3(Z*4,0,0),new e.Vector3(Z*4,0,2*ao),new e.Vector3(0,0,2*ao))}else{i.vertices.push(new e.Vector3(-ao,0,0),new e.Vector3(ao,0,0),new e.Vector3(ao,-Z*4,0),new e.Vector3(-ao,-Z*4,0))}i.faces.push(new e.Face3(0,2,1));i.faces.push(new e.Face3(0,3,2));i.computeFaceNormals();var n=new e.MeshBasicMaterial({transparent:true,vertexColors:e.NoColors,side:e.DoubleSide,opacity:0});var ap=new e.Mesh(i,n);ap.zoom=an;ap.size_3d=ao;ap.use_y_for_z=aq;if(an=="y"){ap.rotateZ(Math.PI/2).rotateX(Math.PI)}ap.GlobalIntersect=function(au){var at=new e.Plane(),aw=this.geometry;at.setFromCoplanarPoints(aw.vertices[0],aw.vertices[1],aw.vertices[2]);at.applyMatrix4(this.matrixWorld);var az=au.ray.origin.clone(),ay=az.clone().addScaledVector(au.ray.direction,10000000000);var ax=at.intersectLine(new e.Line3(az,ay));if(!ax){return undefined}var av=-this.size_3d,ar=this.size_3d;if(this.zoom==="z"){av=0;ar=2*this.size_3d}if(ax[this.zoom]<av){ax[this.zoom]=av}else{if(ax[this.zoom]>ar){ax[this.zoom]=ar}}return ax};ap.ShowSelection=function(ar,aw){var av=this.children[0],at,au=this.zoom;if(!ar||!aw){if(av){this.remove(av);c.Painter.DisposeThreejsObject(av)}return av}if(!av){at=this.geometry.clone();if(au==="z"){at.vertices[1].x=at.vertices[2].x=Z}else{at.vertices[2].y=at.vertices[3].y=-Z}av=new e.Mesh(at,new e.MeshBasicMaterial({color:65280,side:e.DoubleSide}));this.add(av)}else{at=av.geometry}if(au=="z"){at.vertices[0].z=at.vertices[1].z=ar[au];at.vertices[2].z=at.vertices[3].z=aw[au]}else{at.vertices[0].x=at.vertices[3].x=ar[au];at.vertices[1].x=at.vertices[2].x=aw[au]}at.computeFaceNormals();at.verticesNeedUpdate=true;at.normalsNeedUpdate=true;return true};return ap}var ae=new e.Object3D();ae.position.set(0,F,D);ae.rotation.x=1/4*Math.PI;ae.xyid=2;ae.add(new e.LineSegments(ag,t));K.forEach(function(n){var i=new e.Matrix4();i.set(H,0,0,n.grx,0,H,0,-al*H-1.5*Z,0,0,1,0,0,0,0,1);var an=new e.Mesh(n,y);an.applyMatrix(i);ae.add(an)});if(L.zoom){ae.add(ac("x",this.size_xy3d))}m.add(ae);ae=new e.Object3D();ae.position.set(0,j,D);ae.rotation.x=3/4*Math.PI;ae.add(new e.LineSegments(ag,t));K.forEach(function(n){var i=new e.Matrix4();i.set(-H,0,0,n.grx,0,H,0,-al*H-1.5*Z,0,0,-1,0,0,0,0,1);var an=new e.Mesh(n,y);an.applyMatrix(i);ae.add(an)});ae.xyid=4;if(L.zoom){ae.add(ac("x",this.size_xy3d))}m.add(ae);K=[];H=1;al=0;ad=[];while(o.next()){var T=o.grpos;var ah=(o.kind===1);var E=this.y_handle.format(o.tick,true,true);if(o.last_major()){E="y"}else{if(E===null){ah=false;E=""}}if(ah){var C=new e.TextGeometry(E,{font:c.threejs_font_helvetiker_regular,size:Y,height:0,curveSegments:5});C.computeBoundingBox();var v=C.boundingBox.max.x-C.boundingBox.min.x,u=C.boundingBox.max.y-C.boundingBox.min.y;C.translate(-v/2,0,0);al=Math.max(al,u);C.gry=T;K.push(C);if(!o.last_major()){var ak=(o.next_major_grpos()-T);if(v>0){H=Math.min(H,0.9*ak/v)}if(this.y_handle.IsCenterLabels()){C.gry+=ak/2}}}ad.push(0,T,0,(ah?-Z:-Z*0.6),T,0)}var ag=new e.BufferGeometry();ag.addAttribute("position",new e.BufferAttribute(new Float32Array(ad),3));if(!L.use_y_for_z){var O=new e.Object3D();O.position.set(G,0,D);O.rotation.y=-1/4*Math.PI;O.add(new e.LineSegments(ag,t));K.forEach(function(n){var i=new e.Matrix4();i.set(0,H,0,-al*H-1.5*Z,-H,0,0,n.gry,0,0,1,0,0,0,0,1);var an=new e.Mesh(n,y);an.applyMatrix(i);O.add(an)});O.xyid=3;if(L.zoom){O.add(ac("y",this.size_xy3d))}m.add(O);O=new e.Object3D();O.position.set(k,0,D);O.rotation.y=-3/4*Math.PI;O.add(new e.LineSegments(ag,t));K.forEach(function(n){var i=new e.Matrix4();i.set(0,H,0,-al*H-1.5*Z,H,0,0,n.gry,0,0,-1,0,0,0,0,1);var an=new e.Mesh(n,y);an.applyMatrix(i);O.add(an)});O.xyid=1;if(L.zoom){O.add(ac("y",this.size_xy3d))}m.add(O)}K=[];H=1;var ad=[];var J=null,I=null,am=null;if(this.size_z3d){J=[];I=[]}while(aa.next()){var S=aa.grpos;var ah=aa.kind==1;var E=this.z_handle.format(aa.tick,true,true);if(E===null){ah=false;E=""}if(ah&&E&&(E.length>0)){var C=new e.TextGeometry(E,{font:c.threejs_font_helvetiker_regular,size:Y,height:0,curveSegments:5});C.computeBoundingBox();var v=C.boundingBox.max.x-C.boundingBox.min.x,u=C.boundingBox.max.y-C.boundingBox.min.y;C.translate(-v,-u/2,0);C.grz=S;K.push(C);if((am!==null)&&(u>0)){H=Math.min(H,0.9*(S-am)/u)}am=S}if(J&&ah){J.push(G,0,S,k,0,S)}if(I&&ah){I.push(0,F,S,0,j,S)}ad.push(0,0,S,(ah?Z:Z*0.6),0,S)}if(J&&(J.length>0)){var ai=new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var q=new e.Geometry();for(aj=0;aj<J.length;aj+=3){q.vertices.push(new e.Vector3(J[aj],J[aj+1],J[aj+2]))}q.computeLineDistances();var W=new e.LineSegments(q,ai);W.position.set(0,j,0);W.grid=2;W.visible=false;m.add(W);W=new e.LineSegments(q,ai);W.position.set(0,F,0);W.grid=4;W.visible=false;m.add(W)}if(I&&(I.length>0)){var ai=new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2});var q=new e.Geometry();for(aj=0;aj<I.length;aj+=3){q.vertices.push(new e.Vector3(I[aj],I[aj+1],I[aj+2]))}q.computeLineDistances();var W=new e.LineSegments(q,ai);W.position.set(k,0,0);W.grid=3;W.visible=false;m.add(W);W=new e.LineSegments(q,ai);W.position.set(G,0,0);W.grid=1;W.visible=false;m.add(W)}var ag=new e.BufferGeometry();ag.addAttribute("position",new e.BufferAttribute(new Float32Array(ad),3));var w=[];for(var af=0;af<4;++af){w.push(new e.Object3D());K.forEach(function(n){var i=new e.Matrix4();i.set(-H,0,0,2*Z,0,0,1,0,0,H,0,n.grz);var an=new e.Mesh(n,y);an.applyMatrix(i);w[af].add(an)});w[af].add(new e.LineSegments(ag,t));if(L.zoom){w[af].add(ac("z",this.size_z3d,L.use_y_for_z))}w[af].zid=af+2;m.add(w[af])}w[0].position.set(G,j,0);w[0].rotation.z=3/4*Math.PI;w[1].position.set(k,j,0);w[1].rotation.z=1/4*Math.PI;w[2].position.set(k,F,0);w[2].rotation.z=-1/4*Math.PI;w[3].position.set(G,F,0);w[3].rotation.z=-3/4*Math.PI;if(this.size_z3d===0){return}var R=new e.BufferGeometry();R.addAttribute("position",new e.BufferAttribute(new Float32Array([G,0,0,k,0,0]),3));for(var af=0;af<2;++af){var p=new e.LineSegments(R,t);p.position.set(0,F,(af===0)?D:g);p.xyboxid=2;p.bottom=(af==0);m.add(p);p=new e.LineSegments(R,t);p.position.set(0,j,(af===0)?D:g);p.xyboxid=4;p.bottom=(af==0);m.add(p)}var Q=new e.BufferGeometry();Q.addAttribute("position",new e.BufferAttribute(new Float32Array([0,F,0,0,j,0]),3));for(var af=0;af<2;++af){var p=new e.LineSegments(Q,t);p.position.set(G,0,(af===0)?D:g);p.xyboxid=3;p.bottom=(af==0);m.add(p);p=new e.LineSegments(Q,t);p.position.set(k,0,(af===0)?D:g);p.xyboxid=1;p.bottom=(af==0);m.add(p)}var P=new e.BufferGeometry();P.addAttribute("position",new e.BufferAttribute(new Float32Array([0,0,D,0,0,g]),3));for(var af=0;af<4;++af){var p=new e.LineSegments(P,t);p.zboxid=w[af].zid;p.position.copy(w[af].position);m.add(p)}};c.Painter.Box_Vertices=[new e.Vector3(1,1,1),new e.Vector3(1,1,0),new e.Vector3(1,0,1),new e.Vector3(1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,1,1),new e.Vector3(0,0,0),new e.Vector3(0,0,1)];c.Painter.Box_Indexes=[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4];c.Painter.Box_Normals=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1];c.Painter.Box_Segments=[0,2,2,7,7,5,5,0,1,3,3,6,6,4,4,1,1,0,3,2,6,7,4,5];c.Painter.Box_MeshSegments=(function(){var f=new Int32Array(c.Painter.Box_Segments.length);for(var h=0;h<f.length;++h){for(var g=0;g<c.Painter.Box_Indexes.length;++g){if(c.Painter.Box_Segments[h]===c.Painter.Box_Indexes[g]){f[h]=g;break}}}return f})();c.Painter.BinHighlight3D=function(p,h){var n=false,q=null,o=true,s=!p||(p.x1===undefined)||!this.enable_hightlight;if(this.tooltip_selfmesh){o=(this.tooltip_selfmesh!==h);this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color;delete this.tooltip_selfmesh;n=true}if(this.tooltip_mesh){q=this.tooltip_mesh;this.toplevel.remove(this.tooltip_mesh);delete this.tooltip_mesh;n=true}if(s){if(n){this.Render3D()}this.ProvideUserTooltip(null);return}if(p.use_itself){h.save_color=h.material.color;h.material.color=new e.Color(p.color);this.tooltip_selfmesh=h;n=o}else{n=true;var f=c.Painter.Box_Indexes,r=c.Painter.Box_Normals,m=c.Painter.Box_Vertices,l,j,u=new e.Color(p.color?p.color:16711680),i=p.opacity||1;if(!q){l=new Float32Array(f.length*3);j=new Float32Array(f.length*3);var t=new e.BufferGeometry();t.addAttribute("position",new e.BufferAttribute(l,3));t.addAttribute("normal",new e.BufferAttribute(j,3));var x=new e.MeshBasicMaterial({color:u,opacity:i,shading:e.SmoothShading});q=new e.Mesh(t,x)}else{l=q.geometry.attributes.position.array;q.geometry.attributes.position.needsUpdate=true;q.material.color=u;q.material.opacity=i}if(p.x1===p.x2){console.warn("same tip X",p.x1,p.x2)}if(p.y1===p.y2){console.warn("same tip Y",p.y1,p.y2)}if(p.z1===p.z2){p.z2=p.z1+0.0001}for(var v=0,g=-3;v<f.length;++v){var w=m[f[v]];l[v*3]=p.x1+w.x*(p.x2-p.x1);l[v*3+1]=p.y1+w.y*(p.y2-p.y1);l[v*3+2]=p.z1+w.z*(p.z2-p.z1);if(j){if(v%6===0){g+=3}j[v*3]=r[g];j[v*3+1]=r[g+1];j[v*3+2]=r[g+2]}}this.tooltip_mesh=q;this.toplevel.add(q)}if(n){this.Render3D()}if(this.IsUserTooltipCallback()&&this.GetObject()){this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:p.bin,cont:p.value,binx:p.ix,biny:p.iy,binz:p.iz,grx:(p.x1+p.x2)/2,gry:(p.y1+p.y2)/2,grz:(p.z1+p.z2)/2})}};c.Painter.HistPainter_DrawTH2Error=function(){var k=this,m=this.main_painter(),D=m.PrepareColorDraw({rounding:false,use3d:true,extra:1}),B=m.grz.domain()[0],F=m.grz.domain()[1],y,x,w,u,o,A,h,z,g,s,r,f=0,n=null,p=null,v=0;function E(){if(k.options.Zero||(B>0)){return false}return !k._show_empty_bins}for(var C=0;C<2;++C){for(y=D.i1;y<D.i2;++y){A=D.grx[y];z=D.grx[y+1];for(x=D.j1;x<D.j2;++x){u=this.histo.getBinContent(y+1,x+1);if((u<B)||(u>F)){continue}if((u===B)&&E()){continue}if(C===0){f+=3;continue}w=this.histo.getBin(y+1,x+1);o=this.histo.getBinError(w);p[v/18]=w;h=D.gry[x];g=D.gry[x+1];s=m.grz((u-o<B)?B:u-o);r=m.grz((u+o>F)?F:u+o);n[v]=A;n[v+3]=z;n[v+1]=n[v+4]=(h+g)/2;n[v+2]=n[v+5]=(s+r)/2;v+=6;n[v]=n[v+3]=(A+z)/2;n[v+1]=h;n[v+4]=g;n[v+2]=n[v+5]=(s+r)/2;v+=6;n[v]=n[v+3]=(A+z)/2;n[v+1]=n[v+4]=(h+g)/2;n[v+2]=s;n[v+5]=r;v+=6}}if(C===0){if(f===0){return}n=new Float32Array(f*6);p=new Int32Array(f/3)}}var l=new e.BufferGeometry();l.addAttribute("position",new e.BufferAttribute(n,3));var G=c.Painter.root_colors[this.GetObject().fLineColor];var t=new e.LineBasicMaterial({color:new e.Color(G)});if(!c.browser.isIE){t.linewidth=this.GetObject().fLineWidth}var q=new e.LineSegments(l,t);q.painter=this;q.intersect_index=p;q.zmin=B;q.zmax=F;q.tip_color=(this.GetObject().fLineColor===3)?16711680:65280;q.tooltip=function(j){var J=Math.floor(j.index/6);if((J<0)||(J>=this.intersect_index.length)){return null}var I=this.painter,i=I.main_painter(),H=I.Get3DToolTip(this.intersect_index[J]);H.x1=Math.max(-i.size_xy3d,i.grx(I.GetBinX(H.ix-1)));H.x2=Math.min(i.size_xy3d,i.grx(I.GetBinX(H.ix)));H.y1=Math.max(-i.size_xy3d,i.gry(I.GetBinY(H.iy-1)));H.y2=Math.min(i.size_xy3d,i.gry(I.GetBinY(H.iy)));H.z1=i.grz(H.value-H.error<this.zmin?this.zmin:H.value-H.error);H.z2=i.grz(H.value+H.error>this.zmax?this.zmax:H.value+H.error);H.color=this.tip_color;return H};this.toplevel.add(q)};c.Painter.HistPainter_DrawLego=function(){if(!this.draw_content){return}if(this.IsTH2Poly()){return c.Painter.HistPainter_DrawPolyLego.call(this)}if(this.options.Contour&&(this.Dimension()==2)){return c.Painter.HistPainter_DrawContour3D.call(this,true)}if(this.options.Surf&&(this.Dimension()==2)){return c.Painter.HistPainter_DrawTH2Surf.call(this)}if(this.options.Error&&(this.Dimension()==2)){return c.Painter.HistPainter_DrawTH2Error.call(this)}var ac=c.Painter.Box_Vertices,N=c.Painter.Box_Indexes,aI=c.Painter.Box_Normals,aC=c.Painter.Box_Segments,G=[0,1,1,2,2,3,3,0],aK=[new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(1,1,0),new e.Vector3(1,0,0)],x=this.main_painter(),aE=x.grz.domain()[0],w=x.grz.domain()[1],ah=x.PrepareColorDraw({rounding:false,use3d:true,extra:1}),al=ah.i1,ak=ah.i2,aa=ah.j1,Z=ah.j2,R,Q,C,B,p,o,aq,ap,ag,am,aA,g=this,q=this.GetObject(),X=q?q["$baseh"]:null,ab=(this.options.Lego===11)||(this.options.Lego===13);if((al>=ak)||(aa>=Z)){return}function av(i,j,v){ap=q.getBinContent(i+1,j+1);if(X){aq=X.getBinContent(i+1,j+1)}else{if(g.options.BaseLine!==false){aq=g.options.BaseLine}else{aq=g.options.Zero?aE:0}}if(ap<aq){var k=aq;aq=ap;ap=k}if((aq>=L)||(ap<u)){return false}ag=(ap===u)||(aq>=ap);if(!ag||(v>0)){return true}if(q["$baseh"]){return false}if(g.options.Zero||(aE>0)){return true}return g._show_empty_bins}var K=(this.histo.getBin(ak,Z)<65535),af=[aE,w],S=null,aw=0;if((this.options.Lego===12)||(this.options.Lego===14)){af=this.CreateContour(this.histo.fContour?this.histo.fContour.length:20,this.lego_zmin,this.lego_zmax);S=this.GetPalette()}for(var at=0;at<af.length-1;++at){var u=af[at],L=af[at+1],aF=0,aD=0,ao=x.grz(u),aJ=x.grz(L),f=0,z=0;for(R=al;R<ak;++R){for(Q=aa;Q<Z;++Q){if(!av(R,Q,at)){continue}am=!ag&&(at>0);aA=!ag&&(ap>L)&&(at<af.length-2);f+=(ag?12:N.length);if(am){f-=6}if(aA){f-=6}if(ab&&!ag){f-=12;z+=12}}}aw+=f+z;var r=new Float32Array(f*3),aB=new Float32Array(f*3),ai=K?new Uint16Array(f):new Uint32Array(f),V=null,aj=null,y=null,I=0,ae=0,ax,E,P,ad;if(z>0){V=new Float32Array(z*3);aj=new Float32Array(z*3);y=K?new Uint16Array(z):new Uint32Array(z)}for(R=al;R<ak;++R){C=ah.grx[R];B=ah.grx[R+1];for(Q=aa;Q<Z;++Q){if(!av(R,Q,at)){continue}am=!ag&&(at>0);aA=!ag&&(ap>L)&&(at<af.length-2);p=ah.gry[Q];o=ah.gry[Q+1];aF=(aq<=u)?ao:x.grz(aq);aD=(ap>L)?aJ:x.grz(ap);ad=0;P=0;if(ag){ad+=12;P+=24}var J=N.length,h=this.histo.getBin(R+1,Q+1);if(am){J-=6}while(P<J){ax=ac[N[P]];if(ab&&(P<12)){V[ae]=C+ax.x*(B-C);V[ae+1]=p+ax.y*(o-p);V[ae+2]=aF+ax.z*(aD-aF);aj[ae]=aI[ad];aj[ae+1]=aI[ad+1];aj[ae+2]=aI[ad+2];y[ae/3]=h;ae+=3}else{r[I]=C+ax.x*(B-C);r[I+1]=p+ax.y*(o-p);r[I+2]=aF+ax.z*(aD-aF);aB[I]=aI[ad];aB[I+1]=aI[ad+1];aB[I+2]=aI[ad+2];ai[I/3]=h;I+=3}++P;if(P%6===0){ad+=3;if(aA&&(P===N.length-12)){P+=6;ad+=3}}}}}var an=new e.BufferGeometry();an.addAttribute("position",new e.BufferAttribute(r,3));an.addAttribute("normal",new e.BufferAttribute(aB,3));var ar=q.fFillColor,t=c.Painter.root_colors[ar];if(S){var O=Math.floor((at+0.99)*S.length/(af.length-1));if(O>S.length-1){O=S.length-1}t=S[O]}else{if((this.options.Lego===1)||(ar<2)){ar=1;t="white"}}var aH=new e.MeshBasicMaterial({color:t,shading:e.SmoothShading});var U=new e.Mesh(an,aH);U.bins_index=ai;U.painter=this;U.zmin=aE;U.zmax=w;U.baseline=(this.options.BaseLine===false)?aE:this.options.BaseLine;U.tip_color=(ar===3)?16711680:65280;U.tooltip=function(j){if((j.index<0)||(j.index>=this.bins_index.length)){return null}var aP=this.painter,i=aP.main_painter(),aO=aP.GetObject(),aN=aP.Get3DToolTip(this.bins_index[j.index]);aN.x1=Math.max(-i.size_xy3d,i.grx(aP.GetBinX(aN.ix-1)));aN.x2=Math.min(i.size_xy3d,i.grx(aP.GetBinX(aN.ix)));if(aP.Dimension()===1){aN.y1=i.gry(0);aN.y2=i.gry(1)}else{aN.y1=Math.max(-i.size_xy3d,i.gry(aP.GetBinY(aN.iy-1)));aN.y2=Math.min(i.size_xy3d,i.gry(aP.GetBinY(aN.iy)))}var aM=this.baseline,aL=aN.value;if(aO["$baseh"]){aM=aO["$baseh"].getBinContent(aN.ix,aN.iy)}if(aL<aM){var k=aM;aM=aL;aL=k}aN.z1=i.grz(Math.max(this.zmin,aM));aN.z2=i.grz(Math.min(this.zmax,aL));aN.color=this.tip_color;return aN};x.toplevel.add(U);if(z>0){var au=new e.BufferGeometry();au.addAttribute("position",new e.BufferAttribute(V,3));au.addAttribute("normal",new e.BufferAttribute(aj,3));var n=(ar<2)?new e.Color(16711680):new e.Color(d.rgb(t).darker(0.5).toString());var ay=new e.MeshBasicMaterial({color:n,shading:e.SmoothShading});var F=new e.Mesh(au,ay);F.bins_index=y;F.painter=this;F.tooltip=U.tooltip;F.zmin=U.zmin;F.zmax=U.zmax;F.baseline=U.baseline;F.tip_color=U.tip_color;x.toplevel.add(F)}}if(this.options.Lego>12){return}var aG=0,H=0,Y=true,D=0;L=w;u=aE;for(R=al;R<ak;++R){for(Q=aa;Q<Z;++Q){if(!av(R,Q,0)){D++;continue}aG+=(ag?aK.length:ac.length);H+=(ag?G.length:aC.length)}}if(aG>65520){Y=false}if(!Y){aG=H*3}var A=new Float32Array(aG*3),l=Y?new Uint16Array(H):null;var aF=0,aD=0,ao=x.grz(aE),aJ=x.grz(w),az=0,M=0;for(R=al;R<ak;++R){C=ah.grx[R];B=ah.grx[R+1];for(Q=aa;Q<Z;++Q){if(!av(R,Q,0)){continue}p=ah.gry[Q];o=ah.gry[Q+1];aF=(aq<=aE)?ao:x.grz(aq);aD=(ap>w)?aJ:x.grz(ap);var T=ag?G:aC,W=ag?aK:ac;if(Y){for(P=0;P<T.length;++P){l[M++]=az/3+T[P]}for(P=0;P<W.length;++P){ax=W[P];A[az]=C+ax.x*(B-C);A[az+1]=p+ax.y*(o-p);A[az+2]=aF+ax.z*(aD-aF);az+=3}}else{for(P=0;P<T.length;++P){ax=W[T[P]];A[az]=C+ax.x*(B-C);A[az+1]=p+ax.y*(o-p);A[az+2]=aF+ax.z*(aD-aF);az+=3}}}}an=new e.BufferGeometry();an.addAttribute("position",new e.BufferAttribute(A,3));if(Y){an.setIndex(new e.BufferAttribute(l,1))}var m=c.Painter.root_colors[q.fLineColor];aH=new e.LineBasicMaterial({color:new e.Color(m)});if(!c.browser.isIE){aH.linewidth=q.fLineWidth}var s=new e.LineSegments(an,aH);x.toplevel.add(s)};c.Painter.HistPainter_DrawContour3D=function(m){var f=this.main_painter(),l=this.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0});this.getContourIndex(0);var j=this.GetObject(),k=this.fContour,i=this.GetPalette(),h=this,g=2*f.size_z3d;this.BuildContour(l,k,i,function(x,p,n,t,r,o){if(r-t<3){return}if(m){g=f.grz(k[o]);if((g<0)||(g>2*f.size_z3d)){return}}var w=new Float32Array((r-t+1)*3),s=0;for(var q=t;q<=r;++q){w[s]=p[q];w[s+1]=n[q];w[s+2]=g;s+=3}var v=new e.BufferGeometry();v.addAttribute("position",new e.BufferAttribute(w,3));var u=new e.LineBasicMaterial({color:new e.Color(c.Painter.root_colors[j.fLineColor])});var y=new e.Line(v,u);f.toplevel.add(y)})};c.Painter.HistPainter_DrawTH2Surf=function(){var y=this.GetObject(),p=this.main_painter(),J=p.PrepareColorDraw({rounding:false,use3d:true,extra:1,middle:0.5}),ag,ad,B,am,A,ak,H,F,m,g,G=p.grz.domain()[0],ac=p.grz.domain()[1];var L=!p.logz?p.grz:function(i){return i<G?-0.1:p.grz(i)};if((J.i2-J.i1<2)||(J.j2-J.j1<2)){return}var Q=null,I=null,r=true,f=false,al=false,S=false;switch(this.options.Surf){case 11:Q=this.GetContour();f=true;break;case 12:case 15:case 17:Q=this.GetContour();f=true;r=false;break;case 14:r=false;S=true;break;case 16:Q=this.GetContour();al=true;r=false;break;default:Q=p.z_handle.CreateTicks(true);al=true;break}if(Q){I=new Float32Array(Q.length);for(var O=0;O<Q.length;++O){I[O]=L(Q[O])}}else{I=[0,2*p.size_z3d]}var o,l=[],N=[],M=[],q=0,ai=null,ah=0,h=0,V=null,x=0,E=null;function aj(k,j,i){if(k<j){return -1}if(k>i){return 1}return 0}function u(n,aq,ao,k,ap,an){if(!r){return}var j=aj(ao,0,2*p.size_z3d),i=aj(an,0,2*p.size_z3d);if((j===i)&&(j!==0)){return}if(!o){return ++q}if(j!==0){var ar=an-ao;ao=(j<0)?0:2*p.size_z3d;n=k-(k-n)/ar*(an-ao);aq=ap-(ap-aq)/ar*(an-ao)}if(i!==0){var ar=ao-an;an=(i<0)?0:2*p.size_z3d;k=n-(n-k)/ar*(ao-an);ap=aq-(aq-ap)/ar*(ao-an)}ai[ah]=n;ai[ah+1]=aq;ai[ah+2]=ao;ah+=3;ai[ah]=k;ai[ah+1]=ap;ai[ah+2]=an;ah+=3}var T=new Float32Array(6*3),ab=0,P=0;var D=new Float32Array(2*3),Y=0;function C(ao,j,at,an,i,ar,ap,aq){if(ab>=T.length){console.log("more than 6 points???")}var n=(ap-at)/(ar-at),k=3;if((P!==0)&&(Math.abs(n)<Math.abs(P))){T[ab]=T[ab-3];T[ab+1]=T[ab-2];T[ab+2]=T[ab-1];ab-=3;k=6}T[ab]=ao+n*(an-ao);T[ab+1]=j+n*(i-j);T[ab+2]=ap;if(aq&&V){D[Y]=T[ab];D[Y+1]=T[ab+1];D[Y+2]=T[ab+2];Y+=3}ab+=k;P=n}function af(n,j,k){var i=((j-J.i1)*(J.j2-J.j1)+(k-J.j1))*8;if(E[i]>=0){return console.error("More than 8 vertexes for the bin")}var an=i+8+E[i];E[i]--;E[an]=n}function t(ao){for(var at=J.i1;at<J.i2;++at){for(var aq=J.j1;aq<J.j2;++aq){var au=((at-J.i1)*(J.j2-J.j1)+(aq-J.j1))*8;if(E[au]===-1){continue}var ar=(E[au]>=0)?au:au+9+E[au],an=au+8,n=0,k=0,j=0;for(var i=ar;i<an;++i){var ap=E[i];if(ap<0){return console.error("FAILURE in NORMALS RECALCULATIONS")}n+=ao[ap];k+=ao[ap+1];j+=ao[ap+2]}n=n/(an-ar);k=k/(an-ar);j=j/(an-ar);for(var i=ar;i<an;++i){var ap=E[i];ao[ap]=n;ao[ap+1]=k;ao[ap+2]=j}}}}function U(aA,k,av,az,j,au,ay,i,ar,aD){for(var ax=1;ax<I.length;++ax){var ao=aj(av,I[ax-1],I[ax]),an=aj(au,I[ax-1],I[ax]),n=aj(ar,I[ax-1],I[ax]),at=ao+an+n;if(at===3){continue}if(at===-3){return}if(!o){var aq=Math.abs(an-ao)+Math.abs(n-an)+Math.abs(ao-n);if(ao===0){++aq}if(an===0){++aq}if(n===0){++aq}if((aq===1)||(aq===2)){console.error("FOND npnts",aq)}if(aq>2){if(l[ax]===undefined){l[ax]=0}l[ax]+=aq-2}if(((ao>0)||(an>0)||(n>0))&&((ao!==an)||(an!==n)||(n!==ao))){++h}continue}Y=0;ab=0;if(ao===0){T[ab]=aA;T[ab+1]=k;T[ab+2]=av;ab+=3}if(ao!==an){P=0;if((ao<0)||(an<0)){C(aA,k,av,az,j,au,I[ax-1])}if((ao>0)||(an>0)){C(aA,k,av,az,j,au,I[ax],true)}}if(an===0){T[ab]=az;T[ab+1]=j;T[ab+2]=au;ab+=3}if(an!==n){P=0;if((an<0)||(n<0)){C(az,j,au,ay,i,ar,I[ax-1])}if((an>0)||(n>0)){C(az,j,au,ay,i,ar,I[ax],true)}}if(n===0){T[ab]=ay;T[ab+1]=i;T[ab+2]=ar;ab+=3}if(n!==ao){P=0;if((n<0)||(ao<0)){C(ay,i,ar,aA,k,av,I[ax-1])}if((n>0)||(ao>0)){C(ay,i,ar,aA,k,av,I[ax],true)}}if(ab===0){continue}if(ab<9){console.log("found less than 3 points",ab/3);continue}if(V&&(Y===6)){for(var aB=0;aB<6;++aB){V[x+aB]=D[aB]}x+=6}var aC=N[ax],aw=M[ax];if(S&&(ab===9)){af(aw,ag,ad);af(aw+3,ag+1,aD?ad+1:ad);af(aw+6,aD?ag:ag+1,ad+1)}for(var ap=3;ap<ab-3;ap+=3){aC[aw]=T[0];aC[aw+1]=T[1];aC[aw+2]=T[2];aw+=3;aC[aw]=T[ap];aC[aw+1]=T[ap+1];aC[aw+2]=T[ap+2];aw+=3;aC[aw]=T[ap+3];aC[aw+1]=T[ap+4];aC[aw+2]=T[ap+5];aw+=3}M[ax]=aw}}if(S){E=new Int32Array((J.i2-J.i1)*(J.j2-J.j1)*8);for(var X=0;X<E.length;++X){E[X]=-1}}for(o=0;o<2;++o){if(o){for(var Z=1;Z<I.length;++Z){if(l[Z]){N[Z]=new Float32Array(l[Z]*9);M[Z]=0}}if(r&&(q>0)){ai=new Float32Array(q*6)}if(al&&(h>0)){V=new Float32Array(h*6)}}for(ag=J.i1;ag<J.i2-1;++ag){B=J.grx[ag];A=J.grx[ag+1];for(ad=J.j1;ad<J.j2-1;++ad){am=J.gry[ad];ak=J.gry[ad+1];H=L(y.getBinContent(ag+1,ad+1));F=L(y.getBinContent(ag+1,ad+2));m=L(y.getBinContent(ag+2,ad+1));g=L(y.getBinContent(ag+2,ad+2));U(B,am,H,A,ak,g,B,ak,F,true);U(B,am,H,A,am,m,A,ak,g,false);u(B,ak,F,B,am,H);u(B,am,H,A,am,m);if(ag===J.i2-2){u(A,am,m,A,ak,g)}if(ad===J.j2-2){u(B,ak,F,A,ak,g)}}}}for(var Z=1;Z<I.length;++Z){if(N[Z]){if(M[Z]!==l[Z]*9){console.error("SURF faces missmatch lvl",Z,"faces",l[Z],"index",M[Z],"check",l[Z]*9-M[Z])}var z=new e.BufferGeometry();z.addAttribute("position",new e.BufferAttribute(N[Z],3));z.computeVertexNormals();if(S&&(Z===1)){t(z.getAttribute("normal").array)}var s,aa;if(f){s=this.getIndexColor(Z)}else{s=y.fFillColor>1?c.Painter.root_colors[y.fFillColor]:"white";if((this.options.Surf===14)&&(y.fFillColor<2)){s=c.Painter.root_colors[48]}}if(this.options.Surf===14){aa=new e.MeshLambertMaterial({color:s,side:e.DoubleSide})}else{aa=new e.MeshBasicMaterial({color:s,side:e.DoubleSide})}var K=new e.Mesh(z,aa);p.toplevel.add(K);K.painter=this}}if(ai){if(q*6!==ah){console.error("SURF lines mismmatch nsegm",q," lindx",ah,"difference",q*6-ah)}var z=new e.BufferGeometry();z.addAttribute("position",new e.BufferAttribute(ai,3));var w=c.Painter.root_colors[y.fLineColor];var aa=new e.LineBasicMaterial({color:new e.Color(w)});if(!c.browser.isIE){aa.linewidth=y.fLineWidth}var v=new e.LineSegments(z,aa);v.painter=this;p.toplevel.add(v)}if(V){if(h*6!==x){console.error("SURF grid draw mismatch ngridsegm",h,"gindx",x,"diff",h*6-x)}var z=new e.BufferGeometry();z.addAttribute("position",new e.BufferAttribute(V,3));var aa;if(this.options.Surf===1){aa=new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2})}else{aa=new e.LineBasicMaterial({color:new e.Color(c.Painter.root_colors[y.fLineColor])})}var v=new e.LineSegments(z,aa);v.painter=this;p.toplevel.add(v)}if(this.options.Surf===17){c.Painter.HistPainter_DrawContour3D.call(this)}if(this.options.Surf===13){J=p.PrepareColorDraw({rounding:false,use3d:true,extra:100,middle:0});this.getContourIndex(0);var I=this.fContour,ae=this.GetPalette(),W=-1,R=2*p.size_z3d;this.BuildContour(J,I,ae,function(ar,au,aB,aD,ay){if(ay-aD<3){return}var ax=[];for(var aA=aD;aA<=ay;++aA){if((aA===aD)||(au[aA]!==au[aA-1])||(aB[aA]!==aB[aA-1])){ax.push(new e.Vector2(au[aA],aB[aA]))}}if(ax.length<3){return}var k=e.ShapeUtils.triangulateShape(ax,[]);if(!k||(k.length===0)){return}if((W<0)||(W!==ar)){W=ar;R+=0.0001*p.size_z3d}var aq=new Float32Array(k.length*9),ap=new Float32Array(k.length*9),aE=0;for(var az=0;az<k.length;++az){var at=k[az];for(var av=0;av<3;++av){var aC=ax[at[av]];aq[aE]=aC.x;aq[aE+1]=aC.y;aq[aE+2]=R;ap[aE]=0;ap[aE+1]=0;ap[aE+2]=1;aE+=3}}var ao=new e.BufferGeometry();ao.addAttribute("position",new e.BufferAttribute(aq,3));ao.addAttribute("normal",new e.BufferAttribute(ap,3));var an=ae[ar];var aw=new e.MeshBasicMaterial({color:an,shading:e.SmoothShading,side:e.DoubleSide,opacity:0.5});var j=new e.Mesh(ao,aw);j.painter=this;p.toplevel.add(j)})}};c.Painter.HistPainter_DrawPolyLego=function(){var w=this.GetObject(),G=this.main_painter(),C=this.grz.domain()[0],X=this.grz.domain()[1],I,q,Y,D=w.fBins.arr.length,E=0,j=0,M=this.grz(C),L=M;this.fContour=null;this.fCustomContour=false;this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;for(Y=0;Y<D;++Y){q=w.fBins.arr[Y];if(q.fContent<C){continue}I=this.getValueColor(q.fContent,true);if(I===null){continue}if((q.fXmin>G.scale_xmax)||(q.fXmax<G.scale_xmin)||(q.fYmin>G.scale_ymax)||(q.fYmax<G.scale_ymin)){continue}L=this.grz(q.fContent>X?X:q.fContent);var P=[],B=[],Z=1,p=q.fPoly,g=0;if(p._typename=="TMultiGraph"){Z=q.fPoly.fGraphs.arr.length;p=null}for(var H=0;H<Z;++H){if(!p||(H>0)){p=q.fPoly.fGraphs.arr[H]}var k=p.fNpoints,O=p.fX,N=p.fY;while((k>2)&&(O[0]===O[k-1])&&(N[0]===N[k-1])){--k}var m,v;for(var r=0;r<2;++r){var R,Q,u,s,h=G.size_xy3d*G.size_z3d,f=(r>0)?0:h/1000000;m=[];v=null;for(var A=0;A<k;++A){u=G.grx(O[A]);s=G.gry(N[A]);if(A>0){h=(u-R)*(u-R)+(s-Q)*(s-Q)}if(h>f){m.push(new e.Vector2(u,s));R=u;Q=s}}try{if(m.length>2){v=e.ShapeUtils.triangulateShape(m,[])}}catch(aa){v=null}if(v&&(v.length>m.length-3)){break}}if(v&&v.length&&m){P.push(m);B.push(v);g+=v.length*2;if(L>M){g+=m.length*2}}}var K=new Float32Array(g*9),J=0;for(var H=0;H<P.length;++H){var m=P[H],v=B[H];for(var l=0;l<2;++l){for(var S=0;S<v.length;++S){var t=v[S],W=m[t[0]],V=m[t[(l===0)?2:1]],T=m[t[(l===0)?1:2]];K[J]=W.x;K[J+1]=W.y;K[J+2]=l?L:M;J+=3;K[J]=V.x;K[J+1]=V.y;K[J+2]=l?L:M;J+=3;K[J]=T.x;K[J+1]=T.y;K[J+2]=l?L:M;J+=3}}if(L>M){for(var S=0;S<m.length;++S){var W=m[S],V=m[(S>0)?S-1:m.length-1];K[J]=W.x;K[J+1]=W.y;K[J+2]=M;J+=3;K[J]=V.x;K[J+1]=V.y;K[J+2]=M;J+=3;K[J]=V.x;K[J+1]=V.y;K[J+2]=L;J+=3;K[J]=W.x;K[J+1]=W.y;K[J+2]=M;J+=3;K[J]=V.x;K[J+1]=V.y;K[J+2]=L;J+=3;K[J]=W.x;K[J+1]=W.y;K[J+2]=L;J+=3}}}var z=new e.BufferGeometry();z.addAttribute("position",new e.BufferAttribute(K,3));z.computeVertexNormals();var o=this.fPalette[I];var U=new e.MeshBasicMaterial({color:o,shading:e.SmoothShading});var F=new e.Mesh(z,U);G.toplevel.add(F);F.painter=this;F.bins_index=Y;F.draw_z0=M;F.draw_z1=L;F.tip_color=65280;F.tooltip=function(x){var ab=this.painter,i=ab.main_painter(),n=ab.GetObject().fBins.arr[this.bins_index];var y={use_itself:true,x1:i.grx(n.fXmin),x2:i.grx(n.fXmax),y1:i.gry(n.fYmin),y2:i.gry(n.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:n.fContent,color:this.tip_color,info:ab.ProvidePolyBinHints(this.bins_index)};return y};j+=g;E++}};c.Painter.IsRender3DFired=function(f){if(!f||f.renderer===undefined){return false}return f.render_tmout!==undefined};c.Painter.Render3D=function(i){if(i===-1111){var h=c.gStyle.SVGRenderer?new e.SVGRendererNew({antialias:true,alpha:true}):new e.SVGRenderer({antialias:true,alpha:true});h.setSize(this.scene_width,this.scene_height);h.render(this.scene,this.camera);return h.domElement}if(i===undefined){i=5}if((i<=0)||this.usesvg){if("render_tmout" in this){clearTimeout(this.render_tmout)}if(this.renderer===undefined){return}var g=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this.camera,this.toplevel,this.options.FrontBox,this.options.BackBox)}this.renderer.render(this.scene,this.camera);var f=new Date();delete this.render_tmout;if(this.first_render_tm===0){this.first_render_tm=f.getTime()-g.getTime();this.enable_hightlight=(this.first_render_tm<1200)&&this.tooltip_allowed;console.log("First render tm = "+this.first_render_tm)}return}if("render_tmout" in this){return}this.render_tmout=setTimeout(this.Render3D.bind(this,0),i)};c.Painter.Resize3D=function(){var f=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(f);if((this.scene_width===f.width)&&(this.scene_height===f.height)){return false}if((f.width<10)||(f.height<10)){return false}this.scene_width=f.width;this.scene_height=f.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);return true};c.Painter.TH1Painter_Draw3D=function(h,g){var f=this.main_painter();if(g){if((f===this)&&(this.Resize3D!==undefined)&&this.Resize3D()){this.Render3D()}}else{this.Draw3DBins=c.Painter.HistPainter_DrawLego;this.DeleteAtt();if(f===this){this.Create3DScene();this.DrawXYZ(this.toplevel,{use_y_for_z:true,zmult:1.1,zoom:c.gStyle.Zooming})}this.ScanContent(true);this.Draw3DBins();f.Render3D();f.UpdateStatWebCanvas();this.AddKeysHandler()}if(f===this){this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)));this.DrawTitle()}c.CallBack(h)};c.Painter.TH2Painter_Draw3D=function(i,h){this.mode3d=true;var f=this.main_painter();if(h){if((f===this)&&(this.Resize3D!==undefined)&&this.Resize3D()){this.Render3D()}}else{this.Draw3DBins=c.Painter.HistPainter_DrawLego;var j=this.root_pad();this.zmin=j.fLogz?this.gminposbin*0.3:this.gminbin;this.zmax=this.gmaxbin;var g=1.1;if(this.options.minimum!==-1111){this.zmin=this.options.minimum}if(this.options.maximum!==-1111){this.zmax=this.options.maximum;g=1}if(j.fLogz&&(this.zmin<=0)){this.zmin=this.zmax*0.00001}this.DeleteAtt();if(f===this){this.Create3DScene();this.DrawXYZ(this.toplevel,{zmult:g,zoom:c.gStyle.Zooming})}this.Draw3DBins();f.Render3D();this.UpdateStatWebCanvas();this.AddKeysHandler()}if(f===this){this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)||(this.options.Surf===11)||(this.options.Surf===12)));this.DrawTitle()}c.CallBack(i)};c.Painter.PointsCreator=function(g,f,h){if(f===undefined){f=true}this.realwebgl=f;this.webgl=f;this.scale=h||1;if(this.webgl){this.pos=new Float32Array(g*3);this.geom=new e.BufferGeometry();this.geom.addAttribute("position",new e.BufferAttribute(this.pos,3));this.indx=0}else{this.geom=new e.Geometry()}};c.Painter.PointsCreator.prototype.AddPoint=function(f,h,g){if(this.webgl){this.pos[this.indx]=f;this.pos[this.indx+1]=h;this.pos[this.indx+2]=g;this.indx+=3}else{this.geom.vertices.push(new e.Vector3(f,h,g))}};c.Painter.PointsCreator.prototype.CreatePoints=function(h){var g=new e.PointsMaterial({size:(this.webgl?3:1)*this.scale,color:h||"black"});var f=new e.Points(this.geom,g);f.nvertex=1;return f};c.Painter.drawGraph2D=function(h,f,g){this.DecodeOptions=function(j){var k=new c.DrawOptions(j);var i={Color:k.check("COL"),Error:k.check("ERR")&&this.MatchObjectType("TGraph2DErrors"),Markers:k.check("P")};if(!i.Markers&&!i.Error){i.Markers=true}if(!i.Markers){i.Color=false}return i};this.CreateHistogram=function(){var C=this.GetObject();var w=C.fX[0],B=w,D=C.fY[0],F=D,H=C.fZ[0],J=H;for(var A=0;A<C.fNpoints;++A){var s=C.fX[A],q=C.fY[A],o=C.fZ[A],n=this.options.Error?C.fEX[A]:0,m=this.options.Error?C.fEY[A]:0,l=this.options.Error?C.fEZ[A]:0;w=Math.min(w,s-n);B=Math.max(B,s+n);D=Math.min(D,q-m);F=Math.max(F,q+m);H=Math.min(H,o-l);J=Math.max(J,o+l)}if(w>=B){B=w+1}if(D>=F){F=D+1}if(H>=J){J=H+1}var u=(B-w)*0.02,t=(F-D)*0.02,r=(J-H)*0.02,E=w-u,G=B+u,I=D-t,K=F+t,i=H-r,k=J+r;if((E<0)&&(w>=0)){E=w*0.98}if((G>0)&&(B<=0)){G=0}if((I<0)&&(D>=0)){I=D*0.98}if((K>0)&&(F<=0)){K=0}if((i<0)&&(H>=0)){i=H*0.98}if((k>0)&&(J<=0)){k=0}var j=this.GetObject();if(j.fMinimum!=-1111){i=j.fMinimum}if(j.fMaximum!=-1111){k=j.fMaximum}var v=c.CreateHistogram("TH2I",10,10);v.fName=j.fName+"_h";v.fTitle=j.fTitle;v.fXaxis.fXmin=E;v.fXaxis.fXmax=G;v.fYaxis.fXmin=I;v.fYaxis.fXmax=K;v.fZaxis.fXmin=i;v.fZaxis.fXmax=k;v.fMinimum=i;v.fMaximum=k;v.fBits=v.fBits|c.TH1StatusBits.kNoStats;return v};this.Graph2DTooltip=function(i){var m=Math.floor(i.index/this.nvertex);if((m<0)||(m>=this.index.length)){return null}m=this.index[m];var o=this.painter,l=o.grx(this.graph.fX[m]),k=o.gry(this.graph.fY[m]),j=o.grz(this.graph.fZ[m]),n={info:this.tip_name+"<br/>pnt: "+m+"<br/>x: "+o.x_handle.format(this.graph.fX[m])+"<br/>y: "+o.y_handle.format(this.graph.fY[m])+"<br/>z: "+o.z_handle.format(this.graph.fZ[m])};n.x1=l-this.scale0;n.x2=l+this.scale0;n.y1=k-this.scale0;n.y2=k+this.scale0;n.z1=j-this.scale0;n.z2=j+this.scale0;n.color=this.tip_color;return n};this.Redraw=function(){var q=this.main_painter(),l=this.GetObject(),r=1;if(!l||!q||!("renderer" in q)){return}function K(x,R){var z=0;for(var y=0;y<l.fNpoints;++y){if((l.fX[y]<q.scale_xmin)||(l.fX[y]>q.scale_xmax)||(l.fY[y]<q.scale_ymin)||(l.fY[y]>q.scale_ymax)||(l.fZ[y]<x)||(l.fZ[y]>=R)){continue}++z}return z}if((c.gStyle.OptimizeDraw>0)&&!q.webgl){var C=K(q.scale_zmin,q.scale_zmax),D=50000;if(C>D){r=Math.floor(C/D);if(r<=2){r=2}}}var G=c.Painter.createAttMarker(l),L=null,s=[q.scale_zmin,q.scale_zmax],Q=q.size_xy3d/100*G.size*G.scale;if(q.usesvg){Q*=0.3}if(this.options.Color){s=q.GetContour();L=q.GetPalette()}for(var H=0;H<s.length-1;++H){var k=Math.max(s[H],q.scale_zmin),m=Math.min(s[H+1],q.scale_zmax);if(k>=m){continue}var F=Math.floor(K(k,m)/r),E=null,I=0,t=new Int32Array(F),u=0,p=null,N=0;if(this.options.Markers){E=new c.Painter.PointsCreator(F,q.webgl,Q/3)}if(this.options.Error){p=new Float32Array(F*6*3)}for(var J=0;J<l.fNpoints;++J){if((l.fX[J]<q.scale_xmin)||(l.fX[J]>q.scale_xmax)||(l.fY[J]<q.scale_ymin)||(l.fY[J]>q.scale_ymax)||(l.fZ[J]<k)||(l.fZ[J]>=m)){continue}if(r>1){I=(I+1)%r;if(I!==0){continue}}t[u++]=J;var A=q.grx(l.fX[J]),w=q.gry(l.fY[J]),v=q.grz(l.fZ[J]);if(E){E.AddPoint(A,w,v)}if(p){p[N]=q.grx(l.fX[J]-l.fEX[J]);p[N+1]=w;p[N+2]=v;p[N+3]=q.grx(l.fX[J]+l.fEX[J]);p[N+4]=w;p[N+5]=v;N+=6;p[N]=A;p[N+1]=q.gry(l.fY[J]-l.fEY[J]);p[N+2]=v;p[N+3]=A;p[N+4]=q.gry(l.fY[J]+l.fEY[J]);p[N+5]=v;N+=6;p[N]=A;p[N+1]=w;p[N+2]=q.grz(l.fZ[J]-l.fEZ[J]);p[N+3]=A;p[N+4]=w;p[N+5]=q.grz(l.fZ[J]+l.fEZ[J]);N+=6}}if(p){var o=new e.BufferGeometry();o.addAttribute("position",new e.BufferAttribute(p,3));var O=c.Painter.root_colors[this.GetObject().fLineColor];var B=new e.LineBasicMaterial({color:new e.Color(O)});if(!c.browser.isIE){B.linewidth=this.GetObject().fLineWidth}var M=new e.LineSegments(o,B);q.toplevel.add(M);M.graph=l;M.index=t;M.painter=q;M.scale0=0.7*Q;M.tip_name=this.GetTipName();M.tip_color=(l.fMarkerColor===3)?16711680:65280;M.nvertex=6;M.tooltip=this.Graph2DTooltip}if(E){var n=c.Painter.root_colors[l.fMarkerColor];if(L){var P=Math.floor((H+0.99)*L.length/(s.length-1));if(P>=L.length){P=L.length-1}n=L[P]}var j=E.CreatePoints(n);q.toplevel.add(j);j.graph=l;j.index=t;j.painter=q;j.scale0=0.3*Q;j.tip_name=this.GetTipName();j.tip_color=(l.fMarkerColor===3)?16711680:65280;j.tooltip=this.Graph2DTooltip}}q.Render3D(100)};this.SetDivId(h,-1);this.options=this.DecodeOptions(g);if(this.main_painter()){this.SetDivId(h);this.Redraw();return this.DrawingReady()}if(f.fHistogram==null){f.fHistogram=this.CreateHistogram()}c.draw(h,f.fHistogram,"lego",(function(){this.ownhisto=true;this.SetDivId(h);this.Redraw();return this.DrawingReady()}).bind(this));return this};c.TH3Painter=function(f){c.THistPainter.call(this,f);this.Create3DScene=c.Painter.HPainter_Create3DScene;this.mode3d=true};c.TH3Painter.prototype=Object.create(c.THistPainter.prototype);c.TH3Painter.prototype.ScanContent=function(m){if(m&&this.nbinsx&&this.nbinsy&&this.nbinsz){return}var g=this.GetObject();this.nbinsx=g.fXaxis.fNbins;this.nbinsy=g.fYaxis.fNbins;this.nbinsz=g.fZaxis.fNbins;this.xmin=g.fXaxis.fXmin;this.xmax=g.fXaxis.fXmax;this.ymin=g.fYaxis.fXmin;this.ymax=g.fYaxis.fXmax;this.zmin=g.fZaxis.fXmin;this.zmax=g.fZaxis.fXmax;this.gminbin=this.gmaxbin=g.getBinContent(1,1,1);for(var l=0;l<this.nbinsx;++l){for(var h=0;h<this.nbinsy;++h){for(var f=0;f<this.nbinsz;++f){var n=g.getBinContent(l+1,h+1,f+1);if(n<this.gminbin){this.gminbin=n}else{if(n>this.gmaxbin){this.gmaxbin=n}}}}}this.draw_content=this.gmaxbin>0;this.CreateAxisFuncs(true,true)};c.TH3Painter.prototype.CountStat=function(){var t=this.GetObject(),l=0,s=0,z=0,i=0,p=0,x=0,h=0,y=this.GetSelectIndex("x","left"),w=this.GetSelectIndex("x","right"),g=this.GetSelectIndex("y","left"),f=this.GetSelectIndex("y","right"),r=this.GetSelectIndex("z","left"),o=this.GetSelectIndex("z","right"),D={entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},v,C,n,m,k,u,A,B,q,j;for(v=0;v<this.nbinsx+2;++v){m=this.GetBinX(v-0.5);k=(v<y)?0:(v>w?2:1);for(C=0;C<this.nbinsy+2;++C){u=this.GetBinY(C-0.5);A=(C<g)?0:(C>f?2:1);for(n=0;n<this.nbinsz+2;++n){B=this.GetBinZ(n-0.5);q=(n<r)?0:(n>o?2:1);j=t.getBinContent(v,C,n);D.entries+=j;if((k==1)&&(A==1)&&(q==1)){l+=j;s+=m*j;z+=u*j;i+=B*j;p+=m*m*j;x+=u*u*j;h+=B*B*j}}}}if((t.fTsumw>0)&&!this.IsAxisZoomed("x")&&!this.IsAxisZoomed("y")&&!this.IsAxisZoomed("z")){l=t.fTsumw;s=t.fTsumwx;p=t.fTsumwx2;z=t.fTsumwy;x=t.fTsumwy2;i=t.fTsumwz;h=t.fTsumwz2}if(l>0){D.meanx=s/l;D.meany=z/l;D.meanz=i/l;D.rmsx=Math.sqrt(Math.abs(p/l-D.meanx*D.meanx));D.rmsy=Math.sqrt(Math.abs(x/l-D.meany*D.meany));D.rmsz=Math.sqrt(Math.abs(h/l-D.meanz*D.meanz))}D.integral=l;if(t.fEntries>1){D.entries=t.fEntries}return D};c.TH3Painter.prototype.FillStatistic=function(j,l,s){if(this.GetObject()===null){return false}var k=j.GetObject(),i=this.CountStat(),n=l%10,q=Math.floor(l/10)%10,m=Math.floor(l/100)%10,p=Math.floor(l/1000)%10,f=Math.floor(l/10000)%10,g=Math.floor(l/100000)%10,h=Math.floor(l/1000000)%10;if(n>0){k.AddText(this.GetObject().fName)}if(q>0){k.AddText("Entries = "+j.Format(i.entries,"entries"))}if(m>0){k.AddText("Mean x = "+j.Format(i.meanx));k.AddText("Mean y = "+j.Format(i.meany));k.AddText("Mean z = "+j.Format(i.meanz))}if(p>0){k.AddText("Std Dev x = "+j.Format(i.rmsx));k.AddText("Std Dev y = "+j.Format(i.rmsy));k.AddText("Std Dev z = "+j.Format(i.rmsz))}if(h>0){k.AddText("Integral = "+j.Format(i.integral,"entries"))}var o=k.fLines.arr.length,r=o*c.gStyle.StatFontSize;if(r<=0||3==(c.gStyle.StatFont%10)){r=0.25*o*c.gStyle.StatH;k.fY1NDC=0.93-r;k.fY2NDC=0.93}return true};c.TH3Painter.prototype.GetBinTips=function(i,f,k){var h=[],g=this.main_painter();h.push(this.GetTipName());if(g.x_kind=="labels"){h.push("x = "+g.AxisAsText("x",this.GetBinX(i))+"  xbin="+(i+1))}else{h.push("x = ["+g.AxisAsText("x",this.GetBinX(i))+", "+g.AxisAsText("x",this.GetBinX(i+1))+")   xbin="+(i+1))}if(g.y_kind=="labels"){h.push("y = "+g.AxisAsText("y",this.GetBinY(f))+"  ybin="+(f+1))}else{h.push("y = ["+g.AxisAsText("y",this.GetBinY(f))+", "+g.AxisAsText("y",this.GetBinY(f+1))+")  ybin="+(f+1))}if(g.z_kind=="labels"){h.push("z = "+g.AxisAsText("z",this.GetBinZ(k))+"  zbin="+(k+1))}else{h.push("z = ["+g.AxisAsText("z",this.GetBinZ(k))+", "+g.AxisAsText("z",this.GetBinZ(k+1))+")  zbin="+(k+1))}var j=this.GetObject().getBinContent(i+1,f+1,k+1);if(j===Math.round(j)){h.push("entries = "+j)}else{h.push("entries = "+c.FFormat(j,c.gStyle.fStatFormat))}return h};c.TH3Painter.prototype.Draw3DScatter=function(){var t=this.GetObject(),l=this.main_painter(),z=this.GetSelectIndex("x","left",0.5),y=this.GetSelectIndex("x","right",0),h=this.GetSelectIndex("y","left",0.5),f=this.GetSelectIndex("y","right",0),q=this.GetSelectIndex("z","left",0.5),p=this.GetSelectIndex("z","right",0),H=this.GetTipName("<br/>"),C,B,A,E;if((y<=z)||(f<=h)||(p<=q)){return true}var o=(this.gmaxbin>1000)?1000/this.gmaxbin:1,D=0,F=Math.max(0,this.gminbin);for(C=z;C<y;++C){for(B=h;B<f;++B){for(A=q;A<p;++A){E=t.getBinContent(C+1,B+1,A+1);if(E<=F){continue}D+=Math.round(E*o)}}}if(D>(l.webgl?100000:30000)){return false}var v=new c.Painter.PointsCreator(D,l.webgl,l.size_xy3d/200),x=new Int32Array(D),G=0;for(C=z;C<y;++C){for(B=h;B<f;++B){for(A=q;A<p;++A){E=t.getBinContent(C+1,B+1,A+1);if(E<=F){continue}var m=Math.round(E*o);for(var w=0;w<m;++w){var u=this.GetBinX(C+Math.random()),s=this.GetBinY(B+Math.random()),r=this.GetBinZ(A+Math.random());x[G++]=t.getBin(C+1,B+1,A+1);v.AddPoint(l.grx(u),l.gry(s),l.grz(r))}}}}var g=v.CreatePoints(c.Painter.root_colors[t.fMarkerColor]);l.toplevel.add(g);g.bins=x;g.painter=this;g.tip_color=(t.fMarkerColor===3)?16711680:65280;g.tooltip=function(i){var j=Math.floor(i.index/this.nvertex);if((j<0)||(j>=this.bins.length)){return null}var n=this.painter,k=n.Get3DToolTip(this.bins[j]);k.x1=n.grx(n.GetBinX(k.ix-1));k.x2=n.grx(n.GetBinX(k.ix));k.y1=n.gry(n.GetBinY(k.iy-1));k.y2=n.gry(n.GetBinY(k.iy));k.z1=n.grz(n.GetBinZ(k.iz-1));k.z2=n.grz(n.GetBinZ(k.iz));k.color=this.tip_color;k.opacity=0.3;return k};return true};c.TH3Painter.prototype.Draw3DBins=function(){if(!this.draw_content){return}if(!this.options.Box&&!this.options.GLBox&&!this.options.GLColor&&!this.options.Lego){if(this.Draw3DScatter()){return}}var az=this.GetObject().fFillColor,u=c.Painter.root_colors[az],al=0,f=false,ad=false,v=false,I=1,ag=true,J,aA,aC=this.options.Box,aj=0.5;if(!aC&&this.options.Lego){aC=(this.options.Lego===1)?10:this.options.Lego}if((this.options.GLBox===11)||(this.options.GLBox===12)){aj=0.4;f=true;if(this.options.GLBox===12){v=true}var t=c.Painter.TestWebGL()?new e.SphereGeometry(0.5,16,12):new e.SphereGeometry(0.5,8,6);t.applyMatrix(new e.Matrix4().makeRotationX(Math.PI/2));al=t.faces.length*9;J=new Float32Array(al);aA=new Float32Array(al);for(var x=0;x<t.faces.length;++x){J[9*x]=t.vertices[t.faces[x].a].x;J[9*x+1]=t.vertices[t.faces[x].a].y;J[9*x+2]=t.vertices[t.faces[x].a].z;J[9*x+3]=t.vertices[t.faces[x].b].x;J[9*x+4]=t.vertices[t.faces[x].b].y;J[9*x+5]=t.vertices[t.faces[x].b].z;J[9*x+6]=t.vertices[t.faces[x].c].x;J[9*x+7]=t.vertices[t.faces[x].c].y;J[9*x+8]=t.vertices[t.faces[x].c].z;aA[9*x]=t.faces[x].vertexNormals[0].x;aA[9*x+1]=t.faces[x].vertexNormals[0].y;aA[9*x+2]=t.faces[x].vertexNormals[0].z;aA[9*x+3]=t.faces[x].vertexNormals[1].x;aA[9*x+4]=t.faces[x].vertexNormals[1].y;aA[9*x+5]=t.faces[x].vertexNormals[1].z;aA[9*x+6]=t.faces[x].vertexNormals[2].x;aA[9*x+7]=t.faces[x].vertexNormals[2].y;aA[9*x+8]=t.faces[x].vertexNormals[2].z}}else{var af=c.Painter.Box_Indexes,M=c.Painter.Box_Normals,g=c.Painter.Box_Vertices;al=af.length*3;J=new Float32Array(al);aA=new Float32Array(al);for(var aq=0,aB=-3;aq<af.length;++aq){var D=g[af[aq]];J[aq*3]=D.x-0.5;J[aq*3+1]=D.y-0.5;J[aq*3+2]=D.z-0.5;if(aq%6===0){aB+=3}aA[aq*3]=M[aB];aA[aq*3+1]=M[aB+1];aA[aq*3+2]=M[aB+2]}ad=true;if(aC===12){v=true}else{if(aC===13){v=true;ad=false}else{if(this.options.GLColor){v=true;I=0.5;ag=false;ad=false;f=true}}}}if(ag){ag=(this.gminbin||this.gmaxbin)?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1}var C=this.GetObject(),s=this.GetSelectIndex("x","left",0.5),r=this.GetSelectIndex("x","right",0),aw=this.GetSelectIndex("y","left",0.5),at=this.GetSelectIndex("y","right",0),U=this.GetSelectIndex("z","left",0.5),T=this.GetSelectIndex("z","right",0),z=this.GetTipName("<br/>");if((r<=s)||(at<=aw)||(T<=U)){return}var H=(this.grx(this.GetBinX(r))-this.grx(this.GetBinX(s)))/(r-s),G=(this.gry(this.GetBinY(at))-this.gry(this.GetBinY(aw)))/(at-aw),E=(this.grz(this.GetBinZ(T))-this.grz(this.GetBinZ(U)))/(T-U);var ap=0,av,ar,aq,o,l,ac=[],w=0,Z=[];for(av=s;av<r;++av){for(ar=aw;ar<at;++ar){for(aq=U;aq<T;++aq){l=C.getBinContent(av+1,ar+1,aq+1);if((l===0)||(l<this.gminbin)){continue}o=ag?Math.pow(Math.abs(l*ag),0.3333):1;if(o<0.001){continue}ap++;if(!v){continue}var O=this.getValueColor(l,true);if(O!=null){if(ac[O]===undefined){ac[O]=0;Z[O]=w++}ac[O]+=1}else{console.error("not found color for",l)}}}}if(!v){ac.push(ap);w=1;Z=[0]}var Q=new Array(w),p=new Array(w),ai=new Array(w),ah=new Array(w),h=new Array(w),ak=new Array(w),q=new Array(w);for(var F=0;F<ac.length;++F){if(!ac[F]){continue}ap=ac[F];var ae=Z[F];Q[ae]=0;h[ae]=0;if(ad){h[ae]=(ap*al/3>65520)?2:1}p[ae]=new Float32Array(ap*al);ai[ae]=new Float32Array(ap*al);ah[ae]=new Int32Array(ap);if(h[ae]===1){ak[ae]=new Uint16Array(ap*c.Painter.Box_MeshSegments.length)}if(h[ae]===2){q[ae]=new Float32Array(ap*c.Painter.Box_Segments.length*3)}}var ay,Y,ax,X,au,W;for(av=s;av<r;++av){ay=this.GetBinX(av+0.5);Y=this.grx(ay);for(ar=aw;ar<at;++ar){ax=this.GetBinY(ar+0.5);X=this.gry(ax);for(aq=U;aq<T;++aq){l=C.getBinContent(av+1,ar+1,aq+1);if((l===0)||(l<this.gminbin)){continue}o=ag?Math.pow(Math.abs(l*ag),0.3333):1;if(o<0.001){continue}var ae=0;if(v){var O=this.getValueColor(l,true);if(O===null){continue}ae=Z[O]}ap=Q[ae];au=this.GetBinZ(aq+0.5);W=this.grz(au);ah[ae][ap]=C.getBin(av+1,ar+1,aq+1);var V=ap*al,B=p[ae],L=ai[ae];for(var K=0;K<al;K+=3,V+=3){B[V]=Y+J[K]*H*o;B[V+1]=X+J[K+1]*G*o;B[V+2]=W+J[K+2]*E*o;L[V]=aA[K];L[V+1]=aA[K+1];L[V+2]=aA[K+2]}if(h[ae]===1){var am=c.Painter.Box_MeshSegments;V=ap*am.length;var S=Math.round(ap*al/3),aa=ak[ae];for(var an=0;an<am.length;++an){aa[V+an]=S+am[an]}}if(h[ae]===2){var am=c.Painter.Box_Segments,R=q[ae];V=ap*am.length*3;for(var an=0;an<am.length;++an,V+=3){var D=c.Painter.Box_Vertices[am[an]];R[V]=Y+(D.x-0.5)*H*o;R[V+1]=X+(D.y-0.5)*G*o;R[V+2]=W+(D.z-0.5)*E*o}}Q[ae]=ap+1}}}for(var F=0;F<ac.length;++F){if(!ac[F]){continue}ap=ac[F];var ae=Z[F];var m=new e.BufferGeometry();m.addAttribute("position",new e.BufferAttribute(p[ae],3));m.addAttribute("normal",new e.BufferAttribute(ai[ae],3));if(v){u=this.fPalette[F]}var ao=f?new e.MeshLambertMaterial({color:u,opacity:I,transparent:(I<1)}):new e.MeshBasicMaterial({color:u,opacity:I});var A=new e.Mesh(m,ao);A.bins=ah[ae];A.bins_faces=al/3;A.painter=this;A.scalex=aj*H;A.scaley=aj*G;A.scalez=aj*E;A.tip_color=(az===3)?16711680:65280;A.use_scale=ag;A.tooltip=function(i){var aE=Math.floor(i.index/this.bins_faces);if((aE<0)||(aE>=this.bins.length)){return null}var aG=this.painter,aF=aG.Get3DToolTip(this.bins[aE]),n=aG.grx(aG.GetBinX(aF.ix-0.5)),k=aG.gry(aG.GetBinY(aF.iy-0.5)),j=aG.grz(aG.GetBinZ(aF.iz-0.5)),aD=this.use_scale?Math.pow(Math.abs(aF.value*this.use_scale),0.3333):1;aF.x1=n-this.scalex*aD;aF.x2=n+this.scalex*aD;aF.y1=k-this.scaley*aD;aF.y2=k+this.scaley*aD;aF.z1=j-this.scalez*aD;aF.z2=j+this.scalez*aD;aF.color=this.tip_color;return aF};this.toplevel.add(A);if(h[ae]>0){var P=new e.BufferGeometry();if(h[ae]===1){P.setIndex(new e.BufferAttribute(ak[ae],1));P.addAttribute("position",new e.BufferAttribute(p[ae],3))}else{P.addAttribute("position",new e.BufferAttribute(q[ae],3))}var y=c.Painter.root_colors[this.GetObject().fLineColor],N=new e.LineBasicMaterial({color:y}),ab=new e.LineSegments(P,N);this.toplevel.add(ab)}}};c.TH3Painter.prototype.Redraw=function(f){if(f){if(this.Resize3D()){this.Render3D()}}else{this.Create3DScene();this.DrawXYZ(this.toplevel,{zoom:c.gStyle.Zooming});this.Draw3DBins();this.Render3D();this.UpdateStatWebCanvas();this.AddKeysHandler()}this.DrawTitle()};c.TH3Painter.prototype.FillToolbar=function(){var f=this.pad_painter(true);if(f===null){return}f.AddButton(c.ToolbarIcons.auto_zoom,"Unzoom all axes","ToggleZoom","Ctrl *");if(this.draw_content){f.AddButton(c.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox")}};c.TH3Painter.prototype.CanZoomIn=function(h,g,f){if((h=="x")&&(this.GetIndexX(f,0.5)-this.GetIndexX(g,0)>1)){return true}if((h=="y")&&(this.GetIndexY(f,0.5)-this.GetIndexY(g,0)>1)){return true}if((h=="z")&&(this.GetIndexZ(f,0.5)-this.GetIndexZ(g,0)>1)){return true}return false};c.TH3Painter.prototype.AutoZoom=function(){var u=this.GetSelectIndex("x","left"),s=this.GetSelectIndex("x","right"),g=this.GetSelectIndex("y","left"),f=this.GetSelectIndex("y","right"),m=this.GetSelectIndex("z","left"),l=this.GetSelectIndex("z","right"),z,x,w,o=this.GetObject();if((u===s)||(g===f)||(m===l)){return}var t=o.getBinContent(u+1,g+1,m+1);for(z=u;z<s;++z){for(x=g;x<f;++x){for(w=m;w<l;++w){t=Math.min(t,o.getBinContent(z+1,x+1,w+1))}}}if(t>0){return}var F=s,y=u,q=f,C=g,h=l,E=m;for(z=u;z<s;++z){for(x=g;x<f;++x){for(w=m;w<l;++w){if(o.getBinContent(z+1,x+1,w+1)>t){if(z<F){F=z}if(z>=y){y=z+1}if(x<q){q=x}if(x>=C){C=x+1}if(w<h){h=w}if(w>=E){E=w+1}}}}}var p,r,v,A,B,D,n=false;if((F===y-1)&&(F>u+1)&&(y<s-1)){F--;y++}if((q===C-1)&&(q>g+1)&&(C<f-1)){q--;C++}if((h===E-1)&&(h>m+1)&&(E<l-1)){h--;E++}if((F>u||y<s)&&(F<y-1)){p=this.GetBinX(F);r=this.GetBinX(y);n=true}if((q>g||C<f)&&(q<C-1)){v=this.GetBinY(q);A=this.GetBinY(C);n=true}if((h>m||E<l)&&(h<E-1)){B=this.GetBinZ(h);D=this.GetBinZ(E);n=true}if(n){this.Zoom(p,r,v,A,B,D)}};c.TH3Painter.prototype.FillHistContextMenu=function(g){var f=c.getDrawSettings("ROOT."+this.GetObject()._typename,"nosame");g.addDrawMenu("Draw with",f.opts,function(h){if(h==="inspect"){return c.draw(this.divid,this.GetObject(),h)}this.options=this.DecodeOptions(h);this.Redraw()})};c.Painter.drawHistogram3D=function(i,f,h){c.extend(this,new c.TH3Painter(f));this.SetDivId(i,4);this.options=this.DecodeOptions(h);this.CheckPadRange();this.ScanContent();this.Redraw();if(c.gStyle.AutoStat&&(this.create_canvas||f.$snapid)){var g=this.CreateStat(f.$custom_stat);if(g){c.draw(this.divid,g,"")}}this.FillToolbar();return this.DrawingReady()};c.Painter.drawPolyMarker3D=function(h,g,f){this.SetDivId(h);this.Redraw=function(){var k=this.main_painter();if(!k||!("renderer" in k)){return}var j=1,o=50000,m=0;for(var n=0;n<g.fP.length;n+=3){if((g.fP[n]<k.scale_xmin)||(g.fP[n]>k.scale_xmax)||(g.fP[n+1]<k.scale_ymin)||(g.fP[n+1]>k.scale_ymax)||(g.fP[n+2]<k.scale_zmin)||(g.fP[n+2]>k.scale_zmax)){continue}++m}if((c.gStyle.OptimizeDraw>0)&&(m>o)){j=Math.floor(m/o);if(j<=2){j=2}}var t=Math.floor(m/j),l=new c.Painter.PointsCreator(t,k.webgl,k.size_xy3d/100),p=new Int32Array(t),q=0,r=0;for(var n=0;n<g.fP.length;n+=3){if((g.fP[n]<k.scale_xmin)||(g.fP[n]>k.scale_xmax)||(g.fP[n+1]<k.scale_ymin)||(g.fP[n+1]>k.scale_ymax)||(g.fP[n+2]<k.scale_zmin)||(g.fP[n+2]>k.scale_zmax)){continue}if(j>1){q=(q+1)%j;if(q!==0){continue}}p[r++]=n;l.AddPoint(k.grx(g.fP[n]),k.gry(g.fP[n+1]),k.grz(g.fP[n+2]))}var s=l.CreatePoints(c.Painter.root_colors[g.fMarkerColor]);k.toplevel.add(s);s.tip_color=(g.fMarkerColor===3)?16711680:65280;s.poly=g;s.painter=k;s.scale0=0.7*l.scale;s.index=p;s.tooltip=function(i){var x=Math.floor(i.index/this.nvertex);if((x<0)||(x>=this.index.length)){return null}x=this.index[x];var z=this.painter;var y={info:"bin: "+x/3+"<br/>x: "+z.x_handle.format(this.poly.fP[x])+"<br/>y: "+z.y_handle.format(this.poly.fP[x+1])+"<br/>z: "+z.z_handle.format(this.poly.fP[x+2])};var w=z.grx(this.poly.fP[x]),v=z.gry(this.poly.fP[x+1]),u=z.grz(this.poly.fP[x+2]);y.x1=w-this.scale0;y.x2=w+this.scale0;y.y1=v-this.scale0;y.y2=v+this.scale0;y.z1=u-this.scale0;y.z2=u+this.scale0;y.color=this.tip_color;return y};k.Render3D(100)};this.Redraw();return this.DrawingReady()};return c.Painter}));