(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","d3","threejs","dat.gui","JSRoot3DPainter","JSRootGeoBase"],a)}else{if(typeof exports==="object"&&typeof module!=="undefined"){var b=require("./JSRootCore.js");if(!b.nodejs&&(typeof window!="undefined")){require("./dat.gui.min.js")}a(b,require("./d3.min.js"),require("./three.min.js"),require("./JSRoot3DPainter.js"),require("./JSRootGeoBase.js"))}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof d3=="undefined"){throw new Error("d3 is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}if(typeof dat=="undefined"){throw new Error("dat.gui is not defined","JSRootGeoPainter.js")}a(JSROOT,d3,THREE)}}}(function(a,b,c){a.sources.push("geom");if(typeof define==="function"&&define.amd){a.loadScript("$$$style/JSRootGeoPainter.css")}if(typeof a.GEO!=="object"){console.error("JSROOT.GEO namespace is not defined")}a.Toolbar=function(d,e,f){this.bright=f;if((d!==undefined)&&(typeof d.append=="function")){this.element=d.append("div").attr("class","jsroot");this.addButtons(e)}};a.Toolbar.prototype.addButtons=function(e){var d=this;this.buttonsNames=[];e.forEach(function(f){var g=d.element.append("div").attr("class","toolbar-group");f.forEach(function(i){var h=i.name;if(!h){throw new Error("must provide button 'name' in button config")}if(d.buttonsNames.indexOf(h)!==-1){throw new Error("button name '"+h+"' is taken")}d.buttonsNames.push(h);d.createButton(g,i)})})};a.Toolbar.prototype.createButton=function(f,d){var g=d.title;if(g===undefined){g=d.name}if(typeof d.click!=="function"){throw new Error("must provide button 'click' function in button config")}var e=f.append("a").attr("class",this.bright?"toolbar-btn-bright":"toolbar-btn").attr("rel","tooltip").attr("data-title",g).on("click",d.click);this.createIcon(e,d.icon||a.ToolbarIcons.question)};a.Toolbar.prototype.changeBrightness=function(d){this.bright=d;if(!this.element){return}this.element.selectAll(d?".toolbar-btn":".toolbar-btn-bright").attr("class",!d?"toolbar-btn":"toolbar-btn-bright")};a.Toolbar.prototype.createIcon=function(g,e){var f=e.size||512,j=e.scale||1,d=g.append("svg:svg").attr("height","1em").attr("width","1em").attr("viewBox",[0,0,f,f].join(" "));if("recs" in e){var i={};for(var k=0;k<e.recs.length;++k){a.extend(i,e.recs[k]);d.append("rect").attr("x",i.x).attr("y",i.y).attr("width",i.w).attr("height",i.h).attr("fill",i.f)}}else{var h=d.append("svg:path").attr("d",e.path);if(j!==1){h.attr("transform","scale("+j+" "+j+")")}}};a.Toolbar.prototype.removeAllButtons=function(){this.element.remove()};a.TGeoPainter=function(d){if(d&&(d._typename==="TGeoManager")){this.geo_manager=d;d=d.fMasterVolume}if(d&&(d._typename.indexOf("TGeoVolume")===0)){d={_typename:"TGeoNode",fVolume:d,fName:d.fName,$geoh:d.$geoh,_proxy:true}}a.TObjectPainter.call(this,d);this.no_default_title=true;this.Cleanup(true)};a.TGeoPainter.prototype=Object.create(a.TObjectPainter.prototype);a.TGeoPainter.prototype.CreateToolbar=function(e){if(this._toolbar||this._usesvg){return}var d=this;var f=[{name:"toImage",title:"Save as PNG",icon:a.ToolbarIcons.camera,click:function(){d.Render3D(0);var i=d._renderer.domElement.toDataURL("image/png");i.replace("image/png","image/octet-stream");var h=document.createElement("a");if(typeof h.download==="string"){document.body.appendChild(h);h.download="geometry.png";h.href=i;h.click();document.body.removeChild(h)}}}];f.push({name:"control",title:"Toggle control UI",icon:a.ToolbarIcons.rect,click:function(){d.showControlOptions("toggle")}});f.push({name:"enlarge",title:"Emlarge geometry drawing",icon:a.ToolbarIcons.circle,click:function(){d.ToggleEnlarge()}});if(a.gStyle.ContextMenu){f.push({name:"menu",title:"Show context menu",icon:a.ToolbarIcons.question,click:function(){b.event.preventDefault();b.event.stopPropagation();var h=b.event;if(!a.Painter.closeMenu()){a.Painter.createMenu(d,function(i){i.painter.FillContextMenu(i);i.show(h)})}}})}var g=new c.Color(this.options.background);this._toolbar=new a.Toolbar(this.select_main(),[f],(g.r+g.g+g.b)<1)};a.TGeoPainter.prototype.GetGeometry=function(){return this.GetObject()};a.TGeoPainter.prototype.ModifyVisisbility=function(e,d){if(a.GEO.NodeKind(this.GetGeometry())!==0){return}if(e==""){return a.GEO.SetBit(this.GetGeometry().fVolume,a.GEO.BITS.kVisThis,(d==="+"))}var g,f=false;if(e.indexOf("*")<0){g=new RegExp("^"+e+"$");f=true}else{g=new RegExp("^"+e.split("*").join(".*")+"$");f=false}this.FindNodeWithVolume(g,function(h){a.GEO.InvisibleAll.call(h.node.fVolume,(d!=="+"));return f?h:null})};a.TGeoPainter.prototype.decodeOptions=function(g){var q={_grid:false,_bound:false,_debug:false,_full:false,_axis:false,_axis_center:false,_count:false,wireframe:false,scale:new c.Vector3(1,1,1),zoom:1,more:1,maxlimit:100000,maxnodeslimit:3000,use_worker:false,update_browser:true,show_controls:false,highlight:false,select_in_view:false,project:"",is_main:false,tracks:false,clipx:false,clipy:false,clipz:false,ssao:false,script_name:"",transparancy:0,autoRotate:false,background:"#FFFFFF",depthMethod:"box"};var n=a.GetUrlOption("_grid");if(n!==null&&n=="true"){q._grid=true}var n=a.GetUrlOption("_debug");if(n!==null&&n=="true"){q._debug=true;q._grid=true}if(n!==null&&n=="bound"){q._debug=true;q._grid=true;q._bound=true}if(n!==null&&n=="full"){q._debug=true;q._grid=true;q._full=true;q._bound=true}var k=g.indexOf("macro:");if(k>=0){var l=g.indexOf(";",k+6);if(l<0){l=g.length}q.script_name=g.substr(k+6,l-k-6);g=g.substr(0,k)+g.substr(l+1);console.log("script",q.script_name,"rest",g)}while(true){var h=g.indexOf("+"),m=g.indexOf("-");if((h<0)&&(m<0)){break}var s=h,j="+";if((s<0)||((m>=0)&&(m<h))){s=m;j="-"}var r=s+1,p=new RegExp("[,; .]");while((r<g.length)&&!p.test(g[r])&&(g[r]!="+")&&(g[r]!="-")){r++}var e=g.substring(s+1,r);g=g.substr(0,s)+g.substr(r);this.ModifyVisisbility(e,j)}var o=new a.DrawOptions(g);if(o.check("MAIN")){q.is_main=true}if(o.check("TRACKS")){q.tracks=true}if(o.check("DEPTHRAY")||o.check("DRAY")){q.depthMethod="ray"}if(o.check("DEPTHBOX")||o.check("DBOX")){q.depthMethod="box"}if(o.check("DEPTHPNT")||o.check("DPNT")){q.depthMethod="pnt"}if(o.check("DEPTHSIZE")||o.check("DSIZE")){q.depthMethod="size"}if(o.check("DEPTHDFLT")||o.check("DDFLT")){q.depthMethod="dflt"}if(o.check("ZOOM",true)){q.zoom=o.partAsInt(0,100)/100}if(o.check("BLACK")){q.background="#000000"}if(o.check("BKGR_",true)){var f=null;if(o.partAsInt(1)>0){f=a.Painter.root_colors[o.partAsInt()]}else{for(var i=0;i<8;++i){if(a.Painter.root_colors[i].toUpperCase()===o.part){f=a.Painter.root_colors[i]}}}if(f){q.background="#"+new c.Color(f).getHexString()}}if(o.check("MORE3")){q.more=3}if(o.check("MORE")){q.more=2}if(o.check("ALL")){q.more=100}if(o.check("CONTROLS")||o.check("CTRL")){q.show_controls=true}if(o.check("CLIPXYZ")){q.clipx=q.clipy=q.clipz=true}if(o.check("CLIPX")){q.clipx=true}if(o.check("CLIPY")){q.clipy=true}if(o.check("CLIPZ")){q.clipz=true}if(o.check("CLIP")){q.clipx=q.clipy=q.clipz=true}if(o.check("PROJX",true)){q.project="x";if(o.partAsInt(1)>0){q.projectPos=o.partAsInt()}}if(o.check("PROJY",true)){q.project="y";if(o.partAsInt(1)>0){q.projectPos=o.partAsInt()}}if(o.check("PROJZ",true)){q.project="z";if(o.partAsInt(1)>0){q.projectPos=o.partAsInt()}}if(o.check("DFLT_COLORS")||o.check("DFLT")){this.SetRootDefaultColors()}if(o.check("SSAO")){q.ssao=true}if(o.check("NOWORKER")){q.use_worker=-1}if(o.check("WORKER")){q.use_worker=1}if(o.check("NOHIGHLIGHT")||o.check("NOHIGH")){q.highlight=0}if(o.check("HIGHLIGHT")){q.highlight=true}if(o.check("WIRE")){q.wireframe=true}if(o.check("ROTATE")){q.autoRotate=true}if(o.check("INVX")||o.check("INVERTX")){q.scale.x=-1}if(o.check("INVY")||o.check("INVERTY")){q.scale.y=-1}if(o.check("INVZ")||o.check("INVERTZ")){q.scale.z=-1}if(o.check("COUNT")){q._count=true}if(o.check("TRANSP",true)){q.transparancy=o.partAsInt(0,100)/100}if(o.check("OPACITY",true)){q.transparancy=1-o.partAsInt(0,100)/100}if(o.check("AXISCENTER")||o.check("AC")){q._axis=true;q._axis_center=true}if(o.check("AXIS")||o.check("A")){q._axis=true}if(o.check("D")){q._debug=true}if(o.check("G")){q._grid=true}if(o.check("B")){q._bound=true}if(o.check("W")){q.wireframe=true}if(o.check("F")){q._full=true}if(o.check("Y")){q._yup=true}if(o.check("Z")){q._yup=false}return q};a.TGeoPainter.prototype.ActiavteInBrowser=function(e,d){if(typeof e=="string"){e=[e]}if(this._hpainter){this._hpainter.actiavte(e,d);if(!this.options.update_browser){setTimeout(this._hpainter.activate.bind(this._hpainter,[]),2000)}}};a.TGeoPainter.prototype.TestMatrixes=function(){var f=this,h=0,e=0,i=0;var d={domatrix:true,func:function(l){var q=this.getmatrix();var p=this.CopyStack();var s=f._clones.CreateObject3D(p.stack,f._toplevel,"mesh");if(!s){return true}e++;var r=s.matrixWorld,n,j;if(r.equals(q)){return true}if((r.determinant()>0)&&(q.determinant()<-0.9)){n=c.Vector3(1,1,-1);j=q;q=q.clone().scale(n);if(r.equals(q)){return true}}var o=0;for(var m=0;m<16;++m){o=Math.max(o,Math.abs(r.elements[m]-q.elements[m]))}i=Math.max(o,i);if(o<0.0001){return true}console.log(f._clones.ResolveStack(p.stack).name,"maxdiff",o,"determ",r.determinant(),q.determinant());h++;return false}};tm1=new Date().getTime();var g=this._clones.ScanVisible(d);tm2=new Date().getTime();console.log("Compare matrixes total",e,"errors",h,"takes",tm2-tm1,"maxdiff",i)};a.TGeoPainter.prototype.FillContextMenu=function(d){d.add("header: Draw options");d.addchk(this.options.update_browser,"Browser update",function(){this.options.update_browser=!this.options.update_browser;if(!this.options.update_browser){this.ActiavteInBrowser([])}});d.addchk(this.options.show_controls,"Show Controls",function(){this.showControlOptions("toggle")});d.addchk(this.TestAxisVisibility,"Show axes",function(){this.toggleAxisDraw()});d.addchk(this.options.wireframe,"Wire frame",function(){this.options.wireframe=!this.options.wireframe;this.changeWireFrame(this._scene,this.options.wireframe)});d.addchk(this.options.highlight,"Highlight volumes",function(){this.options.highlight=!this.options.highlight});d.add("Reset camera position",function(){this.focusCamera();this.Render3D()});if(!this.options.project){d.addchk(this.options.autoRotate,"Autorotate",function(){this.options.autoRotate=!this.options.autoRotate;this.autorotate(2.5)})}d.addchk(this.options.select_in_view,"Select in view",function(){this.options.select_in_view=!this.options.select_in_view;if(this.options.select_in_view){this.startDrawGeometry()}})};a.TGeoPainter.prototype.changeGlobalTransparancy=function(d,e){var f=1-d;this._toplevel.traverse(function(g){if(g instanceof c.Mesh){if(g.material.alwaysTransparent!==undefined){if(!g.material.alwaysTransparent){g.material.transparent=f!==1}g.material.opacity=Math.min(f,g.material.inherentOpacity)}}});if(!e){this.Render3D(0)}};a.TGeoPainter.prototype.showControlOptions=function(k){if(k==="toggle"){k=!this._datgui}this.options.show_controls=k;if(this._datgui){if(k){return}b.select(this._datgui.domElement).remove();this._datgui.destroy();delete this._datgui;return}if(!k){return}var m=this;this._datgui=new dat.GUI({autoPlace:false,width:Math.min(650,m._renderer.domElement.width/2)});var h=this.select_main();if(h.style("position")=="static"){h.style("position","relative")}b.select(this._datgui.domElement).style("position","absolute").style("top",0).style("right",0);h.node().appendChild(this._datgui.domElement);if(this.options.project){var g=this.getGeomBoundingBox(this.getProjectionSource(),0.01);var f=this.options.project;if(this.options.projectPos===undefined){this.options.projectPos=(g.min[f]+g.max[f])/2}this._datgui.add(this.options,"projectPos",g.min[f],g.max[f]).name(f.toUpperCase()+" projection").onChange(function(p){m.startDrawGeometry()})}else{var g=this.getGeomBoundingBox(this._toplevel,0.01);var j=this._datgui.addFolder("Clipping");for(var l=0;l<3;++l){var f=!l?"x":((l===1)?"y":"z"),d=f.toUpperCase();j.add(this,"enable"+d).name("Enable "+d).listen().onChange(function(p){m._enableSSAO=p?false:m._enableSSAO;m.updateClipping()});var e="clip"+d;if(this[e]===0){this[e]=(g.min[f]+g.max[f])/2}var o=j.add(this,e,g.min[f],g.max[f]).name(d+" Position").onChange(function(p){if(m[this.enbale_flag]){m.updateClipping()}});o.enbale_flag="enable"+d}}var i=this._datgui.addFolder("Appearance");if(this._webgl){i.add(this,"_enableSSAO").name("Smooth Lighting (SSAO)").onChange(function(p){m._renderer.antialias=!m._renderer.antialias;m.enableX=p?false:m.enableX;m.enableY=p?false:m.enableY;m.enableZ=p?false:m.enableZ;m.updateClipping()}).listen()}i.add(this.options,"highlight").name("Highlight Selection").listen().onChange(function(p){if(!p){m.HighlightMesh(null)}});i.add(this.options,"transparancy",0,1).listen().onChange(this.changeGlobalTransparancy.bind(this));i.add(this.options,"wireframe").name("Wireframe").listen().onChange(function(p){m.changeWireFrame(m._scene,m.options.wireframe)});i.addColor(this.options,"background").name("Background").onChange(function(){m._renderer.setClearColor(m.options.background,1);m.Render3D(0);var p=new c.Color(m.options.background);m._toolbar.changeBrightness((p.r+p.g+p.b)<1)});i.add(this,"focusCamera").name("Reset camera position");if(this._webgl){var n=this._datgui.addFolder("Advanced");n.add(this._advceOptions,"aoClamp",0,1).listen().onChange(function(p){m._ssaoPass.uniforms.aoClamp.value=p;m._enableSSAO=true;m.Render3D(0)});n.add(this._advceOptions,"lumInfluence",0,1).listen().onChange(function(p){m._ssaoPass.uniforms.lumInfluence.value=p;m._enableSSAO=true;m.Render3D(0)});n.add(this._advceOptions,"clipIntersection").listen().onChange(function(p){m.clipIntersection=p;m.updateClipping()});n.add(this._advceOptions,"depthTest").onChange(function(p){m._toplevel.traverse(function(q){if(q instanceof c.Mesh){q.material.depthTest=p}});m.Render3D(0)}).listen();n.add(this,"resetAdvanced").name("Reset")}};a.TGeoPainter.prototype.OrbitContext=function(e,d){a.Painter.createMenu(this,function(h){var q=0,k=0,j=0;if(d){for(var i=0;i<d.length;++i){if(d[i].object.stack){k++}if(d[i].object.geo_name){q++}}}if(k+q===0){h.painter.FillContextMenu(h)}else{var g=(k+q)>1;if(g){h.add("header:"+((q>0)?"Items":"Nodes"))}for(var i=0;i<d.length;++i){var l=d[i].object,f,o,p;if(l.geo_name){o=l.geo_name;f=o.substr(o.lastIndexOf("/")+1);if(!f){f=o}p=f}else{if(l.stack){f=h.painter._clones.ResolveStack(l.stack).name;o=h.painter.GetStackFullName(l.stack);p=h.painter.GetItemName();if(f.indexOf("Nodes/")===0){p=f.substr(6)}else{if(f.length>0){p=f}else{if(!p){p="header"}}}}else{continue}}h.add((g?"sub:":"header:")+p,o,function(n){this.ActiavteInBrowser([n],true)});h.add("Browse",o,function(n){this.ActiavteInBrowser([n],true)});if(l.geo_name){h.add("Hide",i,function(n){var r=d[n].object;r.visible=false;if(r.geo_object){r.geo_object.$hidden_via_menu=true}h.painter.Render3D()});if(g){h.add("endsub:")}continue}var m=h.painter.accessObjectWireFrame(l);if(m!==undefined){h.addchk(m,"Wireframe",i,function(r){var n=d[r].object.material;n.wireframe=!n.wireframe;this.Render3D()})}if(++j>1){h.add("Manifest",i,function(r){if(this._last_manifest){this._last_manifest.wireframe=!this._last_manifest.wireframe}if(this._last_hidden){this._last_hidden.forEach(function(s){s.visible=true})}this._last_hidden=[];for(var n=0;n<r;++n){this._last_hidden.push(d[n].object)}this._last_hidden.forEach(function(s){s.visible=false});this._last_manifest=d[r].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()})}h.add("Focus",i,function(n){this.focusCamera(d[n].object)});h.add("Hide",i,function(n){var r=h.painter._clones.ResolveStack(d[n].object.stack);if(r.obj&&(r.node.kind===0)&&r.obj.fVolume){a.GEO.SetBit(r.obj.fVolume,a.GEO.BITS.kVisThis,false);a.GEO.updateBrowserIcons(r.obj.fVolume,this._hpainter)}else{if(r.obj&&(r.node.kind===1)){r.obj.fRnrSelf=false;a.GEO.updateBrowserIcons(r.obj,this._hpainter)}}this.testGeomChanges()});if(g){h.add("endsub:")}}}h.show(e)})};a.TGeoPainter.prototype.FilterIntersects=function(l){for(var d=l.length-1;d>=0;--d){var h=l[d].object;var f=(h.stack!==undefined)||(h.geo_name!==undefined);for(var e=0;(e<d)&&f;++e){if(l[e].object===h){f=false}}if(!f){l.splice(d,1)}}if(this.enableX||this.enableY||this.enableZ){var o=[];for(var j=0;j<l.length;++j){var g=false;var m=l[j].point;if(this.enableX&&this._clipPlanes[0].normal.dot(m)>this._clipPlanes[0].constant){g=true}if(this.enableY&&this._clipPlanes[1].normal.dot(m)>this._clipPlanes[1].constant){g=true}if(this.enableZ&&this._clipPlanes[2].normal.dot(m)>this._clipPlanes[2].constant){g=true}if(g){o.push(l[j])}}l=o}return l};a.TGeoPainter.prototype.testCameraPositionChange=function(){if(!this.options.select_in_view||this._draw_all_nodes){return}var d=a.GEO.CreateProjectionMatrix(this._camera);var e=a.GEO.CreateFrustum(d);if(!e.CheckBox(this.getGeomBoundingBox(this._toplevel))){this.startDrawGeometry()}};a.TGeoPainter.prototype.ResolveStack=function(d){return this._clones&&d?this._clones.ResolveStack(d):null};a.TGeoPainter.prototype.GetStackFullName=function(e){var d=this.GetItemName(),f=this.ResolveStack(e);if(!f||!f.name){return d}return d?(d+"/"+f.name):f.name};a.TGeoPainter.prototype.HighlightMesh=function(d,f,m,j,l){if(!this.options.highlight){d=null}else{if(m){var e=this.getExtrasContainer();if(e&&e.children){for(var g=0;g<e.children.length;++g){if(e.children[g].geo_object===m){d=e.children[g];break}}}}else{if(j&&this._toplevel){this._toplevel.traverse(function(k){if((k instanceof c.Mesh)&&(k.stack===j)){d=k}})}}}if(!l){if(d){if(!m){m=d.geo_object}if(!j){j=d.stack}}var i=!this._main_painter?this._slave_painters:this._main_painter._slave_painters.concat([this._main_painter]);for(var g=0;g<i.length;++g){if(i[g]!==this){i[g].HighlightMesh(null,f,m,j,true)}}}var h=this._selected_mesh;if(h===d){return}if(h!==null){h.material.color=h.originalColor;delete h.originalColor;if(h.normalLineWidth){h.material.linewidth=h.normalLineWidth}if(h.normalMarkerSize){h.material.size=h.normalMarkerSize}}this._selected_mesh=d;if(d!==null){d.originalColor=d.material.color;d.material.color=new c.Color(f||16755251);if(d.hightlightLineWidth){d.material.linewidth=d.hightlightLineWidth}if(d.highlightMarkerSize){d.material.size=d.highlightMarkerSize}}this.Render3D(0)};a.TGeoPainter.prototype.addOrbitControls=function(){if(this._controls||this._usesvg){return}var d=this;this.tooltip_allowed=(a.gStyle.Tooltip>0);this._controls=a.Painter.CreateOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);if(this.options.project){this._controls.enableRotate=false}this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=function(f){var m=null,h=null,g=null,l=[];for(var e=0;e<f.length;++e){var j=f[e].object,i=null;if(!j){continue}if(j.geo_object){i=j.geo_name}else{if(j.stack){i=d.GetStackFullName(j.stack)}}if(i===null){continue}if(i.indexOf("<prnt>")==0){i=d.GetItemName()+i.substr(6)}l.push(i);if(!m){m=j;h=i;if(m.stack){g=d.ResolveStack(m.stack)}}}d.HighlightMesh(m);if(d.options.update_browser){if(d.options.highlight&&h){l=[h]}d.ActiavteInBrowser(l)}if(!g||!g.obj){return h}return{name:g.obj.fName,title:g.obj.fTitle||g.obj._typename,line:h}};this._controls.ProcessMouseLeave=function(){if(d.options.update_browser){d.ActiavteInBrowser([])}};this._controls.ProcessDblClick=function(){if(d._last_manifest){d._last_manifest.wireframe=!d._last_manifest.wireframe;if(d._last_hidden){d._last_hidden.forEach(function(e){e.visible=true})}delete d._last_hidden;delete d._last_manifest;d.Render3D()}else{d.adjustCameraPosition()}}};a.TGeoPainter.prototype.addTransformControl=function(){if(this._tcontrols){return}if(!this.options._debug&&!this.options._grid){return}this._tcontrols=new c.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);var d=this;window.addEventListener("keydown",function(e){switch(e.keyCode){case 81:d._tcontrols.setSpace(d._tcontrols.space==="local"?"world":"local");break;case 17:d._tcontrols.setTranslationSnap(Math.ceil(d._overall_size)/50);d._tcontrols.setRotationSnap(c.Math.degToRad(15));break;case 84:d._tcontrols.setMode("translate");break;case 82:d._tcontrols.setMode("rotate");break;case 83:d._tcontrols.setMode("scale");break;case 187:case 107:d._tcontrols.setSize(d._tcontrols.size+0.1);break;case 189:case 109:d._tcontrols.setSize(Math.max(d._tcontrols.size-0.1,0.1));break}});window.addEventListener("keyup",function(e){switch(e.keyCode){case 17:d._tcontrols.setTranslationSnap(null);d._tcontrols.setRotationSnap(null);break}});this._tcontrols.addEventListener("change",function(){d.Render3D(0)})};a.TGeoPainter.prototype.nextDrawAction=function(){if(!this._clones||(this.drawing_stage==0)){return false}if(this.drawing_stage==1){if(this.options.use_worker>0){if(!this._worker){this.startWorker();return 1}if(!this._worker_ready){return 1}}var r=this._clones.MarkVisisble(),x=null,q=null;if(this.options.select_in_view&&!this._first_drawing){x=a.GEO.CreateProjectionMatrix(this._camera);q=a.GEO.CreateFrustum(x);if(q.CheckBox(this.getGeomBoundingBox(this._toplevel))){x=null;q=null}}this._current_face_limit=this.options.maxlimit;this._current_nodes_limit=this.options.maxnodeslimit;if(x){this._current_face_limit*=1.25;this._current_nodes_limit*=1.25}var u=!a.BatchMode&&((r>10000)||(x&&(this._clones.ScanVisible()>100000)));if(u&&a.source_dir.indexOf("file://")==0){console.log("disable worker for jsroot from file system");u=false}if(u&&!this._worker&&(this.options.use_worker>=0)){this.startWorker()}if(!u||!this._worker_ready){var D=this._clones.CollectVisibles(this._current_face_limit,q,this._current_nodes_limit);this._new_draw_nodes=D.lst;this._draw_all_nodes=D.complete;this.drawing_stage=3;return true}var m={collect:this._current_face_limit,collect_nodes:this._current_nodes_limit,visible:this._clones.GetVisibleFlags(),matrix:x?x.elements:null};this.submitToWorker(m);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==2){this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==3){this.drawing_log="Analyse visibles";if(this._draw_nodes){var p=this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(var w=0;w<p.length;++w){this._clones.CreateObject3D(p[w].stack,this._toplevel,"delete_mesh")}if(p.length>0){this.drawing_log="Delete "+p.length+" nodes"}}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return true}if(this.drawing_stage===4){this.drawing_log="Collect shapes";var v=this._clones.CollectShapes(this._draw_nodes);this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,v);this.drawing_stage=5;return true}if(this.drawing_stage===5){if(this.canSubmitToWorker()){var m={limit:this._current_face_limit,shapes:[]},y=0;for(var w=0;w<this._build_shapes.length;++w){var B=null,A=this._build_shapes[w];if(A.ready||A.geom){B={id:A.id,ready:true,nfaces:a.GEO.numGeometryFaces(A.geom),refcnt:A.refcnt}}else{B=a.clone(A,null,true);y++}m.shapes.push(B)}if(y>0){this.submitToWorker(m);this.drawing_log="Worker build shapes";this.drawing_stage=6;return 2}}this.drawing_stage=7}if(this.drawing_stage===6){return 2}if((this.drawing_stage===7)||(this.drawing_stage===8)){if(this.drawing_stage===7){var D=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500);if(D.done){this.drawing_stage=8}else{this.drawing_log="Creating: "+D.shapes+" / "+this._build_shapes.length+" shapes,  "+D.faces+" faces";if(D.notusedshapes<30){return true}}}var k=new Date().getTime(),s=true,t=this.options.project?this._full_geom:this._toplevel;for(var w=0;w<this._draw_nodes.length;++w){var g=this._draw_nodes[w];if(g.done){continue}var f=this._build_shapes[g.shapeid];if(!f.ready){if(this.drawing_stage===8){console.warn("shape marked as not ready when should")}s=false;continue}g.done=true;f.used=true;if(!f.geom||(f.nfaces===0)){this._clones.CreateObject3D(g.stack,t,"delete_mesh");continue}var l=this._clones.origin[g.nodeid];var B=this._clones.nodes[g.nodeid];var h=a.GEO.getNodeProperties(B.kind,l,true);this._num_meshes++;this._num_faces+=f.nfaces;var C=this._clones.CreateObject3D(g.stack,t,this.options);h.material.wireframe=this.options.wireframe;h.material.side=this.bothSides?c.DoubleSide:c.FrontSide;var e;if(C.matrixWorld.determinant()>-0.9){e=new c.Mesh(f.geom,h.material)}else{e=a.GEO.createFlippedMesh(C,f,h.material)}C.add(e);e.stack=g.stack;e.renderOrder=this._clones.maxdepth-g.stack.length;e.$jsroot_order=C.$jsroot_depth;if(this.options._debug||this.options._full){var o=new c.WireframeGeometry(e.geometry),j=new c.LineBasicMaterial({color:h.fillcolor,linewidth:(l&&l.fVolume)?l.fVolume.fLineWidth:1}),d=new c.LineSegments(o,j);C.add(d)}if(this.options._bound||this.options._full){var z=new c.BoxHelper(e);C.add(z)}var i=new Date().getTime();if(i-k>500){s=false;break}}if(s){if(this.options.project){this.drawing_log="Build projection";this.drawing_stage=10;return true}this.drawing_log="Building done";this.drawing_stage=0;return false}if(this.drawing_stage>7){this.drawing_log="Building meshes "+this._num_meshes+" / "+this._num_faces}return true}if(this.drawing_stage===9){if(!this._main_painter){console.warn("MAIN PAINTER DISAPPER");this.drawing_stage=0;return false}if(!this._main_painter._drawing_ready){return 1}this.drawing_stage=10}if(this.drawing_stage===10){this.doProjection();this.drawing_log="Building done";this.drawing_stage=0;return false}console.error("never come here stage = "+this.drawing_stage);return false};a.TGeoPainter.prototype.getProjectionSource=function(){if(this._clones_owner){return this._full_geom}if(!this._main_painter){console.warn("MAIN PAINTER DISAPPER");return null}if(!this._main_painter._drawing_ready){console.warn("MAIN PAINTER NOT READY WHEN DO PROJECTION");return null}return this._main_painter._toplevel};a.TGeoPainter.prototype.getGeomBoundingBox=function(f,e){var d=new c.Box3();if(!f){d.min.x=d.min.y=d.min.z=-1;d.max.x=d.max.y=d.max.z=1;return d}d.makeEmpty();f.traverse(function(g){if((g instanceof c.Mesh)&&g.stack){a.GEO.getBoundingBox(g,d)}});if(e!==undefined){d.expandByVector(d.getSize().multiplyScalar(e))}return d};a.TGeoPainter.prototype.doProjection=function(){var j=this.getProjectionSource(),f=this;if(!j){return false}a.Painter.DisposeThreejsObject(this._toplevel,true);var i=this.options.project;if(this.options.projectPos===undefined){var h=this.getGeomBoundingBox(j),g=h.min[this.options.project],d=h.max[this.options.project],e=(g+d)/2;if((g<0)&&(d>0)&&(Math.abs(e)<0.2*Math.max(-g,d))){e=0}this.options.projectPos=e}j.traverse(function(m){if(!(m instanceof c.Mesh)||!m.stack){return}var l=a.GEO.projectGeometry(m.geometry,m.parent.matrixWorld,f.options.project,f.options.projectPos,m._flippedMesh);if(!l){return}var k=new c.Mesh(l,m.material.clone());f._toplevel.add(k);k.stack=m.stack});return true};a.TGeoPainter.prototype.SameMaterial=function(f,d){if((f===null)||(d===null)){return f===d}if(f.fVolume.fLineColor>=0){return(f.fVolume.fLineColor===d.fVolume.fLineColor)}var g=(f.fVolume.fMedium!==null)?f.fVolume.fMedium.fMaterial:null;var e=(d.fVolume.fMedium!==null)?d.fVolume.fMedium.fMaterial:null;if(g===e){return true}if((g===null)||(e===null)){return false}return(g.fFillStyle===e.fFillStyle)&&(g.fFillColor===e.fFillColor)};a.TGeoPainter.prototype.createScene=function(k,j,e,g){this._scene=new c.Scene();this._scene.fog=new c.Fog(16777215,1,10000);this._scene.overrideMaterial=new c.MeshLambertMaterial({color:7340287,transparent:true,opacity:0.2,depthTest:false});this._scene_width=e;this._scene_height=g;this._camera=new c.PerspectiveCamera(25,e/g,1,10000);this._camera.up=this.options._yup?new c.Vector3(0,1,0):new c.Vector3(0,0,1);this._scene.add(this._camera);this._selected_mesh=null;this._overall_size=10;this._toplevel=new c.Object3D();this._scene.add(this._toplevel);if(k){this._renderer=a.gStyle.SVGRenderer?new c.SVGRendererNew({antialias:true,alpha:true}):new c.SVGRenderer({antialias:true,alpha:true})}else{this._renderer=j?new c.WebGLRenderer({antialias:true,logarithmicDepthBuffer:false,preserveDrawingBuffer:true}):new c.CanvasRenderer({antialias:true});this._renderer.setPixelRatio(window.devicePixelRatio)}this._renderer.setClearColor(this.options.background,1);this._renderer.setSize(e,g,!this._fit_main_area);this._renderer.localClippingEnabled=true;if(this._fit_main_area){this._renderer.domElement.style.width="100%";this._renderer.domElement.style.height="100%";var d=this.select_main();if(d.style("position")=="static"){d.style("position","relative")}}this._animating=false;this.clipIntersection=true;this.bothSides=false;this.enableX=this.enableY=this.enableZ=false;this.clipX=this.clipY=this.clipZ=0;this._clipPlanes=[new c.Plane(new c.Vector3(1,0,0),this.clipX),new c.Plane(new c.Vector3(0,this.options._yup?-1:1,0),this.clipY),new c.Plane(new c.Vector3(0,0,this.options._yup?1:-1),this.clipZ)];this._pointLight=new c.PointLight(15724527,1);this._camera.add(this._pointLight);this._pointLight.position.set(10,10,10);this._defaultAdvanced={aoClamp:0.7,lumInfluence:0.4,clipIntersection:true,depthTest:true};this._enableSSAO=this.options.ssao;if(j){var i=new c.RenderPass(this._scene,this._camera);this._depthMaterial=new c.MeshDepthMaterial({side:c.DoubleSide});this._depthMaterial.depthPacking=c.RGBADepthPacking;this._depthMaterial.blending=c.NoBlending;var f={minFilter:c.LinearFilter,magFilter:c.LinearFilter};this._depthRenderTarget=new c.WebGLRenderTarget(e,g,f);this._ssaoPass=new c.ShaderPass(c.SSAOShader);this._ssaoPass.renderToScreen=true;this._ssaoPass.uniforms.tDepth.value=this._depthRenderTarget.texture;this._ssaoPass.uniforms.size.value.set(e,g);this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far;this._ssaoPass.uniforms.onlyAO.value=false;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence;this._effectComposer=new c.EffectComposer(this._renderer);this._effectComposer.addPass(i);this._effectComposer.addPass(this._ssaoPass)}this._advceOptions={};this.resetAdvanced()};a.TGeoPainter.prototype.startDrawGeometry=function(d){if(!d&&(this.drawing_stage!==0)){this._draw_nodes_again=true;return}this._startm=new Date().getTime();this._last_render_tm=this._startm;this._last_render_meshes=0;this.drawing_stage=1;this._drawing_ready=false;this.drawing_log="collect visible";this._num_meshes=0;this._num_faces=0;this._selected_mesh=null;if(this.options.project){if(this._clones_owner){if(this._full_geom){this.drawing_stage=10;this.drawing_log="build projection"}else{this._full_geom=new c.Object3D()}}else{this.drawing_stage=9;this.drawing_log="wait for main painter"}}delete this._last_manifest;delete this._last_hidden;delete this._draw_nodes_again;this.continueDraw()};a.TGeoPainter.prototype.resetAdvanced=function(){if(this._webgl){this._advceOptions.aoClamp=this._defaultAdvanced.aoClamp;this._advceOptions.lumInfluence=this._defaultAdvanced.lumInfluence;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence}this._advceOptions.depthTest=this._defaultAdvanced.depthTest;this._advceOptions.clipIntersection=this._defaultAdvanced.clipIntersection;this.clipIntersection=this._defaultAdvanced.clipIntersection;var d=this;this._toplevel.traverse(function(e){if(e instanceof c.Mesh){e.material.depthTest=d._defaultAdvanced.depthTest}});this.Render3D(0)};a.TGeoPainter.prototype.updateMaterialSide=function(d,e){if((this.bothSides===d)&&!e){return}this._scene.traverse(function(f){if(f.hasOwnProperty("material")&&("emissive" in f.material)){f.material.side=d?c.DoubleSide:c.FrontSide;f.material.needsUpdate=true}});this.bothSides=d};a.TGeoPainter.prototype.updateClipping=function(e){this._clipPlanes[0].constant=this.clipX;this._clipPlanes[1].constant=-this.clipY;this._clipPlanes[2].constant=this.options._yup?-this.clipZ:this.clipZ;var d=this;this._scene.traverse(function(f){if(f instanceof c.Mesh){f.material.clipIntersection=d.clipIntersection;f.material.clippingPlanes=[];if(d.enableX){f.material.clippingPlanes.push(d._clipPlanes[0])}if(d.enableY){f.material.clippingPlanes.push(d._clipPlanes[1])}if(d.enableZ){f.material.clippingPlanes.push(d._clipPlanes[2])}}});this.updateMaterialSide(this.enableX||this.enableY||this.enableZ);if(!e){this.Render3D(0)}};a.TGeoPainter.prototype.getGeomBox=function(){var e=this.getExtrasContainer("collect");var f=this.getGeomBoundingBox(this._toplevel);if(e){for(var d=0;d<e.length;++d){this._toplevel.add(e[d])}}return f};a.TGeoPainter.prototype.adjustCameraPosition=function(j){if(!this._toplevel){return}var h=this.getGeomBoundingBox(this._toplevel);var m=h.max.x-h.min.x,l=h.max.y-h.min.y,i=h.max.z-h.min.z,g=(h.max.x+h.min.x)/2,f=(h.max.y+h.min.y)/2,d=(h.max.z+h.min.z)/2;this._overall_size=2*Math.max(m,l,i);this._scene.fog.near=this._overall_size*2;this._camera.near=this._overall_size/350;this._scene.fog.far=this._overall_size*12;this._camera.far=this._overall_size*12;if(this._webgl){this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far}if(j){this.clipX=g;this.clipY=f;this.clipZ=d}this._camera.updateProjectionMatrix();var e=2*this.options.zoom;if(this.options.project){switch(this.options.project){case"x":this._camera.position.set(e*1.5*Math.max(l,i),0,0);break;case"y":this._camera.position.set(0,e*1.5*Math.max(m,i),0);break;case"z":this._camera.position.set(0,0,e*1.5*Math.max(m,l));break}}else{if(this.options._yup){this._camera.position.set(g-e*Math.max(m,i),f+e*l,d-e*Math.max(m,i))}else{this._camera.position.set(g-e*Math.max(m,l),f-e*Math.max(m,l),d+e*i)}}this._lookat=new c.Vector3(g,f,d);this._camera.lookAt(this._lookat);this._pointLight.position.set(m/5,l/5,i/5);if(this._controls){this._controls.target.copy(this._lookat);this._controls.update()}if(this.options.select_in_view){this.startDrawGeometry()}};a.TGeoPainter.prototype.focusOnItem=function(f){if(!f||!this._clones){return}var d=this._clones.FindStackByName(f);if(!d){return}var e=this._clones.ResolveStack(d,true);this.focusCamera(e,false)};a.TGeoPainter.prototype.focusCamera=function(n,w){if(this.options.project){return this.adjustCameraPosition()}var r=w===undefined?false:w;var l=new c.Box3();if(n===undefined){l=this.getGeomBoundingBox(this._toplevel)}else{if(n instanceof c.Mesh){l.setFromObject(n)}else{var B=new c.Vector3().setFromMatrixPosition(n.matrix),q=n.node,o=new c.Vector3(q.fDX,q.fDY,q.fDZ).multiplyScalar(0.5);l.min=B.clone().sub(o);l.max=B.clone().add(o)}}var A=l.max.x-l.min.x,y=l.max.y-l.min.y,x=l.max.z-l.min.z,v=(l.max.x+l.min.x)/2,u=(l.max.y+l.min.y)/2,s=(l.max.z+l.min.z)/2;var D;if(this.options._yup){D=new c.Vector3(v-2*Math.max(A,x),u+2*y,s-2*Math.max(A,x))}else{D=new c.Vector3(v-2*Math.max(A,y),u-2*Math.max(A,y),s+2*x)}var C=new c.Vector3(v,u,s);var p=this._camera.position.distanceTo(C);var t=this._controls.target;var m=200;var j=0;var g=D.sub(this._camera.position).divideScalar(m);var k=C.sub(t).divideScalar(m);if(r){var h=this.getGeomBoundingBox(this._toplevel);this.clipX=this.enableX?this.clipX:h.min.x;this.clipY=this.enableY?this.clipY:h.min.y;this.clipZ=this.enableZ?this.clipZ:h.min.z;this.enableX=this.enableY=this.enableZ=true;var f=((l.max.x+l.min.x)/2-this.clipX)/m,e=((l.max.y+l.min.y)/2-this.clipY)/m,d=((l.max.z+l.min.z)/2-this.clipZ)/m;this.updateClipping()}var z=this;this._animating=true;function i(){if(z._animating===undefined){return}if(z._animating){requestAnimationFrame(i)}else{z.startDrawGeometry()}var E=-Math.cos((2*Math.PI*j)/m)+1;z._camera.position.add(g.clone().multiplyScalar(E));t.add(k.clone().multiplyScalar(E));z._lookat=t;z._camera.lookAt(z._lookat);z._camera.updateProjectionMatrix();if(r){z.clipX+=f*E;z.clipY+=e*E;z.clipZ+=d*E;z.updateClipping()}else{z.Render3D()}j++;z._animating=j<m}i()};a.TGeoPainter.prototype.autorotate=function(h){var f=(h===undefined)?2:h,d=this,g=new Date();function e(){if(!d._renderer||!d.options){return}var i=new Date();if(d.options.autoRotate){requestAnimationFrame(e)}if(d._controls){d._controls.autoRotate=d.options.autoRotate;d._controls.autoRotateSpeed=f*(i.getTime()-g.getTime())/16.6666;d._controls.update()}g=new Date();d.Render3D(0)}if(this._webgl){e()}};a.TGeoPainter.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var d=new c.BoxHelper(this._toplevel);this._scene.add(d)}this._scene.add(new c.AxisHelper(2*this._overall_size));this._scene.add(new c.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};a.TGeoPainter.prototype.drawCount=function(l,h){var i="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+l+"<br/>Time to clone: "+h+"ms <br/>";this._clones.ScanVisible();var k=this,m=0;var n={cnt:[],func:function(o){if(this.cnt[this.last]===undefined){this.cnt[this.last]=1}else{this.cnt[this.last]++}m+=a.GEO.CountNumShapes(k._clones.GetNodeShape(o.id));return true}};var e=new Date().getTime();var g=this._clones.ScanVisible(n);var d=new Date().getTime();i+="Total visible nodes: "+g+"<br/>";i+="Total shapes: "+m+"<br/>";for(var j=0;j<n.cnt.length;++j){if(n.cnt[j]!==undefined){i+=("  lvl"+j+": "+n.cnt[j]+"<br/>")}}i+="Time to scan: "+(d-e)+"ms <br/>";i+="<br/><br/>Check timing for matrix calculations ...<br/>";var f=this.select_main().style("overflow","auto").html(i);setTimeout(function(){n.domatrix=true;e=new Date().getTime();g=k._clones.ScanVisible(n);d=new Date().getTime();f.append("p").text("Time to scan with matrix: "+(d-e)+"ms");k.DrawingReady()},100);return this};a.TGeoPainter.prototype.PerformDrop=function(j,k,e,f,i){if(j&&(j.$kind==="TTree")){var d="extract_geo_tracks";if(f&&f.indexOf("$")>0){d=f.substr(0,f.indexOf("$"));f=f.substr(f.indexOf("$")+1)}var h=a.findFunction(d);if(!h){return a.CallBack(i)}var g=this;return h(j,f,function(l){if(l){g.drawExtras(l);g.Render3D(100)}a.CallBack(i)})}if(this.drawExtras(j,k,true)){if(e){e._painter=this}this.Render3D(100)}a.CallBack(i)};a.TGeoPainter.prototype.MouseOverHierarchy=function(d,g,e){if(!this.options){return}var f=e._obj;if(this.options._debug){console.log("Mouse over",d,g,(f?f._typename:"---"))}if(!f||(f._typename!=="TEveTrack"&&f._typename!=="TEvePointSet"&&f._typename!=="TPolyMarker3D")){return}this.HighlightMesh(null,65280,d?f:null)};a.TGeoPainter.prototype.clearExtras=function(){this.getExtrasContainer("delete");delete this._extraObjects;this.Render3D()};a.TGeoPainter.prototype.addExtra=function(d,e){if(this._extraObjects===undefined){this._extraObjects=a.Create("TList")}if(this._extraObjects.arr.indexOf(d)>=0){return false}this._extraObjects.Add(d,e);delete d.$hidden_via_menu;return true};a.TGeoPainter.prototype.ExtraObjectVisible=function(h,e,d){if(!this._extraObjects){return}var k=h.itemFullName(e),g=this._extraObjects.opt.indexOf(k);if((g<0)&&e._obj){g=this._extraObjects.arr.indexOf(e._obj);if(g>=0){this._extraObjects.opt[g]=k}}if(g<0){return}var i=this._extraObjects.arr[g],f=i.$hidden_via_menu?false:true;if(d){i.$hidden_via_menu=f;f=!f;var j=null;this._toplevel.traverse(function(l){if(l.geo_object===i){j=l}});if(j){j.visible=f}else{if(f){this.drawExtras(i)}}if(j||f){this.Render3D()}}return f};a.TGeoPainter.prototype.drawExtras=function(g,j,h){if(!g||g._typename===undefined){return false}if(!h&&g.$hidden_via_menu){return false}var f=false;if((g._typename==="TList")||(g._typename==="TObjArray")){if(!g.arr){return false}for(var i=0;i<g.arr.length;++i){var e=g.arr[i];var d=(j===undefined)?g.opt[i]:(j+"/["+i+"]");if(this.drawExtras(e,d,h)){f=true}}}else{if(g._typename==="TGeoTrack"){if(h&&!this.addExtra(g,j)){return false}f=this.drawGeoTrack(g,j)}else{if(g._typename==="TEveTrack"){if(h&&!this.addExtra(g,j)){return false}f=this.drawEveTrack(g,j)}else{if((g._typename==="TEvePointSet")||(g._typename==="TPolyMarker3D")){if(h&&!this.addExtra(g,j)){return false}f=this.drawHit(g,j)}else{if(g._typename==="TEveGeoShapeExtract"){if(h&&!this.addExtra(g,j)){return false}f=this.drawExtraShape(g,j)}}}}}return f};a.TGeoPainter.prototype.getExtrasContainer=function(i,f){if(!this._toplevel){return null}if(!f){f="tracks"}var g=null,d=[];for(var j=0;j<this._toplevel.children.length;++j){var h=this._toplevel.children[j];if(!h._extras){continue}if(i==="collect"){d.push(h);continue}if(h._extras===f){g=h;break}}if(i==="collect"){for(var e=0;e<d.length;++e){this._toplevel.remove(d[e])}return d}if(i==="delete"){if(g){this._toplevel.remove(g)}a.Painter.DisposeThreejsObject(g);return null}if((i!=="get")&&!g){g=new c.Object3D();g._extras=f;this._toplevel.add(g)}return g};a.TGeoPainter.prototype.drawGeoTrack=function(f,m){if(!f||!f.fNpoints){return false}var r=f.fLineWidth||1,d=a.Painter.root_colors[f.fLineColor]||"rgb(255,0,255)";if(a.browser.isWin){r=1}var o=Math.round(f.fNpoints/4),e=new Float32Array((o-1)*6),q=0,n=this.options.projectPos,l=(this.options.project==="x"),j=(this.options.project==="y"),i=(this.options.project==="z");for(var h=0;h<o-1;++h){e[q]=l?n:f.fPoints[h*4];e[q+1]=j?n:f.fPoints[h*4+1];e[q+2]=i?n:f.fPoints[h*4+2];e[q+3]=l?n:f.fPoints[h*4+4];e[q+4]=j?n:f.fPoints[h*4+5];e[q+5]=i?n:f.fPoints[h*4+6];q+=6}var p=new c.BufferGeometry();p.addAttribute("position",new c.BufferAttribute(e,3));var g=new c.LineBasicMaterial({color:d,linewidth:r});var s=new c.LineSegments(p,g);s.geo_name=m;s.geo_object=f;if(!a.browser.isWin){s.hightlightLineWidth=r*3;s.normalLineWidth=r}this.getExtrasContainer().add(s);return true};a.TGeoPainter.prototype.drawEveTrack=function(f,m){if(!f||(f.fN<=0)){return false}var q=f.fLineWidth||1,d=a.Painter.root_colors[f.fLineColor]||"rgb(255,0,255)";if(a.browser.isWin){q=1}var e=new Float32Array((f.fN-1)*6),p=0,n=this.options.projectPos,l=(this.options.project==="x"),j=(this.options.project==="y"),i=(this.options.project==="z");for(var h=0;h<f.fN-1;++h){e[p]=l?n:f.fP[h*3];e[p+1]=j?n:f.fP[h*3+1];e[p+2]=i?n:f.fP[h*3+2];e[p+3]=l?n:f.fP[h*3+3];e[p+4]=j?n:f.fP[h*3+4];e[p+5]=i?n:f.fP[h*3+5];p+=6}var o=new c.BufferGeometry();o.addAttribute("position",new c.BufferAttribute(e,3));var g=new c.LineBasicMaterial({color:d,linewidth:q});var r=new c.LineSegments(o,g);r.geo_name=m;r.geo_object=f;if(!a.browser.isWin){r.hightlightLineWidth=q*3;r.normalLineWidth=q}this.getExtrasContainer().add(r);return true};a.TGeoPainter.prototype.drawHit=function(G,v){if(!G||!G.fN||(G.fN<0)){return false}var B=25*G.fMarkerSize,p=a.Painter.root_colors[G.fMarkerColor]||"rgb(0,0,255)",l=this._webgl,w=G.fN-1,q=1,I=B*0.3,g=a.Painter.Box_Indexes,A=a.Painter.Box_Normals,o=a.Painter.Box_Vertices,j=0,n,m,f=this.options.projectPos,d=(this.options.project==="x"),J=(this.options.project==="y"),H=(this.options.project==="z");if(l){n=new Float32Array(w*3);m=null}else{if(w>1000){q=Math.floor(w/500);if(q<2){q=2}}n=new Float32Array(g.length*3*Math.floor(w/q));m=new Float32Array(g.length*3*Math.floor(w/q))}for(var E=0;E<w;E+=q){var t=d?f:G.fP[E*3],s=J?f:G.fP[E*3+1],r=H?f:G.fP[E*3+2];if(l){n[j]=t;n[j+1]=s;n[j+2]=r;j+=3;continue}for(var D=0,h=-3;D<g.length;++D){var F=o[g[D]];n[j]=t+(F.x-0.5)*I;n[j+1]=s+(F.y-0.5)*I;n[j+2]=r+(F.z-0.5)*I;if(D%6===0){h+=3}m[j]=A[h];m[j+1]=A[h+1];m[j+2]=A[h+2];j+=3}}var C=new c.BufferGeometry(),e;C.addAttribute("position",new c.BufferAttribute(n,3));if(m){C.addAttribute("normal",new c.BufferAttribute(m,3))}if(l){var u=new c.PointsMaterial({size:B,color:p});e=new c.Points(C,u);e.highlightMarkerSize=B*3;e.normalMarkerSize=B}else{var u=new c.MeshBasicMaterial({color:p,shading:c.SmoothShading});e=new c.Mesh(C,u)}e.geo_name=v;e.geo_object=G;this.getExtrasContainer().add(e);return true};a.TGeoPainter.prototype.drawExtraShape=function(e,f){var d=a.GEO.build(e);if(!d){return false}d.geo_name=f;d.geo_object=e;this.getExtrasContainer().add(d);return true};a.TGeoPainter.prototype.FindNodeWithVolume=function(d,h,g,j,l){var f=false,k=null;if(!g){g=this.GetGeometry();if(!g&&(a.GEO.NodeKind(g)!==0)){return null}j=this.geo_manager?g.fName:"";f=true;l=[]}else{if(j.length>0){j+="/"}j+=g.fName}if(!g.fVolume||g.fVolume._searched){return null}if(d.test(g.fVolume.fName)){k=h({node:g,item:j});if(k){return k}}g.fVolume._searched=true;l.push(g.fVolume);if(g.fVolume.fNodes){for(var e=0;e<g.fVolume.fNodes.arr.length;++e){k=this.FindNodeWithVolume(d,h,g.fVolume.fNodes.arr[e],j,l);if(k){break}}}if(f){for(var e=0,i=l.length;e<i;++e){delete l[e]._searched}}return k};a.TGeoPainter.prototype.SetRootDefaultColors=function(){var h={kWhite:0,kBlack:1,kGray:920,kRed:632,kGreen:416,kBlue:600,kYellow:400,kMagenta:616,kCyan:432,kOrange:800,kSpring:820,kTeal:840,kAzure:860,kViolet:880,kPink:900};var d=110,f=[];for(var g=0;g<d;g++){f.push(h.kGray)}f[3]=h.kYellow-10;f[4]=f[5]=h.kGreen-10;f[6]=f[7]=h.kBlue-7;f[8]=f[9]=h.kMagenta-3;f[10]=f[11]=h.kRed-10;f[12]=h.kGray+1;f[13]=h.kBlue-10;f[14]=h.kOrange+7;f[16]=h.kYellow+1;f[20]=h.kYellow-10;f[24]=f[25]=f[26]=h.kBlue-8;f[29]=h.kOrange+9;f[79]=h.kOrange-2;var e={test:function(){return true}};this.FindNodeWithVolume(e,function(i){var k=i.node.fVolume;var l=k.fMedium;if(!l){return null}var j=l.fMaterial;var m=Math.round(j.fZ);k.fLineColor=f[m];if(j.fDensity<0.1){j.fFillStyle=3000+60}})};a.TGeoPainter.prototype.checkScript=function(i,g){var d=this,h=this.GetGeometry(),e="";if(this.geo_manager){e=h.fName}if(!i||(i.length<3)||(a.GEO.NodeKind(h)!==0)){return a.CallBack(g,h,e)}var f={GetVolume:function(k){var l=new RegExp("^"+k+"$");var j=d.FindNodeWithVolume(l,function(m){return m});if(!j){console.log("Did not found "+k+" volume")}return{found:j,fVolume:j?j.node.fVolume:null,InvisibleAll:function(m){a.GEO.InvisibleAll.call(this.fVolume,m)},Draw:function(){if(!this.found||!this.fVolume){return}h=this.found.node;e=this.found.item;console.log("Select volume for drawing",this.fVolume.fName,e)},SetTransparency:function(m){if(this.fVolume&&this.fVolume.fMedium&&this.fVolume.fMedium.fMaterial){this.fVolume.fMedium.fMaterial.fFillStyle=3000+m}},SetLineColor:function(m){if(this.fVolume){this.fVolume.fLineColor=m}}}},DefaultColors:function(){d.SetRootDefaultColors()},SetMaxVisNodes:function(j){console.log("Automatic visible depth for "+j+" nodes");if(j>0){d.options.maxnodeslimit=j}}};a.progress("Loading macro "+i);a.NewHttpRequest(i,"text",function(k){if(!k||(k.length==0)){return a.CallBack(g,h,e)}var j=k.split("\n");l(0);function l(q){var r=new Date().getTime();while(q<j.length){var m=j[q++].trim();if(m.indexOf("//")==0){continue}if(m.indexOf("gGeoManager")<0){continue}m=m.replace("->GetVolume",".GetVolume");m=m.replace("->InvisibleAll",".InvisibleAll");m=m.replace("->SetMaxVisNodes",".SetMaxVisNodes");m=m.replace("->DefaultColors",".DefaultColors");m=m.replace("->Draw",".Draw");m=m.replace("->SetTransparency",".SetTransparency");m=m.replace("->SetLineColor",".SetLineColor");if(m.indexOf("->")>=0){continue}try{var p=new Function("gGeoManager",m);p(f)}catch(o){console.error("Problem by processing "+m)}var n=new Date().getTime();if(n-r>300){a.progress("exec "+m);return setTimeout(l.bind(this,q),1)}}a.CallBack(g,h,e)}}).send()};a.TGeoPainter.prototype.prepareObjectDraw=function(i,g){if(this._main_painter){this._clones_owner=false;this._clones=null;this._clones=this._main_painter._clones;console.log("Reuse clones",this._clones.nodes.length,"from main painter")}else{var e=new Date().getTime();this._clones_owner=true;this._clones=new a.GEO.ClonedNodes(i);this._clones.name_prefix=g;var h=this._clones.MarkVisisble(true);if(h<=0){h=this._clones.MarkVisisble(false)}else{h=this._clones.MarkVisisble(true,true)}var d=new Date().getTime();console.log("Creating clones",this._clones.nodes.length,"takes",d-e,"uniquevis",h);if(this.options._count){return this.drawCount(h,d-e)}}this.options.maxlimit=(this._webgl?200000:100000)*this.options.more;this._first_drawing=true;if(this.options.use_worker>0){this.startWorker()}var f=this.size_for_3d(this._usesvg?3:undefined);this._fit_main_area=(f.can3d===-1);this.createScene(this._usesvg,this._webgl,f.width,f.height);this.add_3d_canvas(f,this._renderer.domElement);this.AccessTopPainter(true);this.CreateToolbar();this.startDrawGeometry(true)};a.TGeoPainter.prototype.continueDraw=function(){if(this.drawing_stage===0){return}var e=new Date().getTime(),d=this._first_drawing?1000:200,f=e;while(true){var g=this.nextDrawAction();if(!g){break}f=new Date().getTime();if(f-this._startm>100000){this.drawing_stage=0;break}if((g===true)&&(f-e<d)){continue}if((f-e>d)||(g===1)||(g===2)){a.progress(this.drawing_log);if(this._first_drawing&&this._webgl&&(this._num_meshes-this._last_render_meshes>100)&&(f-this._last_render_tm>2.5*d)){this.adjustCameraPosition();this.Render3D(-1);this._last_render_tm=new Date().getTime();this._last_render_meshes=this._num_meshes}if(g!==2){setTimeout(this.continueDraw.bind(this),(g===1)?100:1)}return}}var h=f-this._startm;if(this._first_drawing){a.console("Create tm = "+h+" meshes "+this._num_meshes+" faces "+this._num_faces)}if(h>300){a.progress("Rendering geometry");return setTimeout(this.completeDraw.bind(this,true),10)}this.completeDraw(true)};a.TGeoPainter.prototype.TestCameraPosition=function(){this._camera.updateMatrixWorld();var d=this._camera.position.clone();if(this._last_camera_position){var e=this._last_camera_position.distanceTo(d);if(e<(this._overall_size||1000)/10000){return}}this._last_camera_position=d;if(this._webgl){a.GEO.produceRenderOrder(this._toplevel,d,this.options.depthMethod,this._clones)}};a.TGeoPainter.prototype.Render3D=function(g,f){if(!this._renderer){console.warn("renderer object not exists - check code");return}if(g===undefined){g=5}if((g<=0)||this._usesvg){if("render_tmout" in this){clearTimeout(this.render_tmout)}var e=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this._camera,this._toplevel)}this.TestCameraPosition();if(this._webgl&&this._enableSSAO){this._scene.overrideMaterial=this._depthMaterial;this._renderer.render(this._scene,this._camera,this._depthRenderTarget,true);this._scene.overrideMaterial=null;this._effectComposer.render()}else{this._renderer.render(this._scene,this._camera)}var d=new Date();this.last_render_tm=d.getTime()-e.getTime();delete this.render_tmout;if((this.first_render_tm===0)&&f){this.first_render_tm=this.last_render_tm;a.console("First render tm = "+this.first_render_tm)}return}if(!this.render_tmout){this.render_tmout=setTimeout(this.Render3D.bind(this,0,f),g)}};a.TGeoPainter.prototype.startWorker=function(){if(this._worker){return}this._worker_ready=false;this._worker_jobs=0;var d=this;this._worker=new Worker(a.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(f){if(typeof f.data!=="object"){return}if("log" in f.data){return a.console("geo: "+f.data.log)}if("progress" in f.data){return a.progress(f.data.progress)}f.data.tm3=new Date().getTime();if("init" in f.data){d._worker_ready=true;return a.console("Worker ready: "+(f.data.tm3-f.data.tm0))}d.processWorkerReply(f.data)};this._worker.postMessage({init:true,browser:a.browser,tm0:new Date().getTime(),clones:this._clones.nodes,sortmap:this._clones.sortmap})};a.TGeoPainter.prototype.canSubmitToWorker=function(d){if(!this._worker){return false}return this._worker_ready&&((this._worker_jobs==0)||d)};a.TGeoPainter.prototype.submitToWorker=function(d){if(!this._worker){return false}this._worker_jobs++;d.tm0=new Date().getTime();this._worker.postMessage(d)};a.TGeoPainter.prototype.processWorkerReply=function(f){this._worker_jobs--;if("collect" in f){this._new_draw_nodes=f.new_nodes;this._draw_all_nodes=f.complete;this.drawing_stage=3;return this.continueDraw()}if("shapes" in f){for(var g=0;g<f.shapes.length;++g){var e=f.shapes[g],d=this._build_shapes[g];if(e.buf_pos&&e.buf_norm){if(e.buf_pos.length===0){d.geom=null}else{if(e.buf_pos.length!==e.buf_norm.length){console.error("item.buf_pos",e.buf_pos.length,"item.buf_norm",e.buf_norm.length);d.geom=null}else{d.geom=new c.BufferGeometry();d.geom.addAttribute("position",new c.BufferAttribute(e.buf_pos,3));d.geom.addAttribute("normal",new c.BufferAttribute(e.buf_norm,3))}}d.ready=true;d.nfaces=e.nfaces}}f.tm4=new Date().getTime();this.drawing_stage=7;return this.continueDraw()}};a.TGeoPainter.prototype.testGeomChanges=function(){if(this._main_painter){console.warn("Get testGeomChanges call for slave painter");return this._main_painter.testGeomChanges()}this.startDrawGeometry();for(var d=0;d<this._slave_painters.length;++d){this._slave_painters[d].startDrawGeometry()}};a.TGeoPainter.prototype.drawSimpleAxis=function(){var f=this.getGeomBoundingBox(this._toplevel);this.getExtrasContainer("delete","axis");var g=this.getExtrasContainer("create","axis");var e=0.02*Math.max((f.max.x-f.min.x),(f.max.y-f.min.y),(f.max.z-f.min.z)),h=["x","y","z"],s=[0,0,0];if(this.options._axis_center){for(var u=0;u<3;++u){var v=h[u];if((f.min[v]<=0)&&(f.max[v]>=0)){continue}s[u]=(f.min[v]+f.max[v])/2}}for(var u=0;u<3;++u){var r=new Float32Array(6),l,v=h[u];function t(w){var k=f.max[v]-f.min[v];if(k<2){return w.toFixed(3)}if(Math.abs(w)>100000){return w.toExponential(3)}return Math.round(w).toString()}var o=t(f.max[v]);r[0]=f.min.x;r[1]=f.min.y;r[2]=f.min.z;r[3]=f.min.x;r[4]=f.min.y;r[5]=f.min.z;switch(u){case 0:r[3]=f.max.x;l="red";if(this.options._yup){o="X "+o}else{o+=" X"}break;case 1:r[4]=f.max.y;l="green";if(this.options._yup){o+=" Y"}else{o="Y "+o}break;case 2:r[5]=f.max.z;l="blue";o+=" Z";break}if(this.options._axis_center){for(var m=0;m<6;++m){if((m%3)!==u){r[m]=s[m%3]}}}var j=new c.BufferGeometry();j.addAttribute("position",new c.BufferAttribute(r,3));var q=new c.LineBasicMaterial({color:l});var d=new c.LineSegments(j,q);g.add(d);var n=new c.MeshBasicMaterial({color:l});if((s[u]===0)&&(s[u]>=f.min[v])&&(s[u]<=f.max[v])){if(!this.options._axis_center||(u===0)){j=new c.SphereBufferGeometry(e*0.25);d=new c.Mesh(j,n);d.translateX((u===0)?s[0]:r[0]);d.translateY((u===1)?s[1]:r[1]);d.translateZ((u===2)?s[2]:r[2]);g.add(d)}}var p=new c.TextGeometry(o,{font:a.threejs_font_helvetiker_regular,size:e,height:0,curveSegments:5});d=new c.Mesh(p,n);var i=new c.Box3().setFromObject(d);d.translateX(r[3]);d.translateY(r[4]);d.translateZ(r[5]);if(this.options._yup){switch(u){case 0:d.rotateY(Math.PI);d.translateX(-i.max.x-e*0.5);d.translateY(-i.max.y/2);break;case 1:d.rotateX(-Math.PI/2);d.rotateY(-Math.PI/2);d.translateX(e*0.5);d.translateY(-i.max.y/2);break;case 2:d.rotateY(-Math.PI/2);d.translateX(e*0.5);d.translateY(-i.max.y/2);break}}else{switch(u){case 0:d.rotateX(Math.PI/2);d.translateY(-i.max.y/2);d.translateX(e*0.5);break;case 1:d.rotateX(Math.PI/2);d.rotateY(-Math.PI/2);d.translateX(-i.max.x-e*0.5);d.translateY(-i.max.y/2);break;case 2:d.rotateX(Math.PI/2);d.rotateZ(Math.PI/2);d.translateX(e*0.5);d.translateY(-i.max.y/2);break}}g.add(d);p=new c.TextGeometry(t(f.min[v]),{font:a.threejs_font_helvetiker_regular,size:e,height:0,curveSegments:5});d=new c.Mesh(p,n);i=new c.Box3().setFromObject(d);d.translateX(r[0]);d.translateY(r[1]);d.translateZ(r[2]);if(this.options._yup){switch(u){case 0:d.rotateY(Math.PI);d.translateX(e*0.5);d.translateY(-i.max.y/2);break;case 1:d.rotateX(-Math.PI/2);d.rotateY(-Math.PI/2);d.translateY(-i.max.y/2);d.translateX(-i.max.x-e*0.5);break;case 2:d.rotateY(-Math.PI/2);d.translateX(-i.max.x-e*0.5);d.translateY(-i.max.y/2);break}}else{switch(u){case 0:d.rotateX(Math.PI/2);d.translateX(-i.max.x-e*0.5);d.translateY(-i.max.y/2);break;case 1:d.rotateX(Math.PI/2);d.rotateY(-Math.PI/2);d.translateY(-i.max.y/2);d.translateX(e*0.5);break;case 2:d.rotateX(Math.PI/2);d.rotateZ(Math.PI/2);d.translateX(-i.max.x-e*0.5);d.translateY(-i.max.y/2);break}}g.add(d)}this.TestAxisVisibility=function(w,k){if(!w){this.getExtrasContainer("delete","axis");delete this.TestAxisVisibility;this.Render3D();return}}};a.TGeoPainter.prototype.toggleAxisDraw=function(d){if(this.TestAxisVisibility){if(!d){this.TestAxisVisibility(null,this._toplevel)}}else{this.drawSimpleAxis()}};a.TGeoPainter.prototype.completeDraw=function(d){var e=false;if(!this.options){console.warn("options object does not exist in completeDraw - something went wrong");return}if(this._first_drawing){this.adjustCameraPosition(true);this._first_drawing=false;e=true;if(this._webgl){this.enableX=this.options.clipx;this.enableY=this.options.clipy;this.enableZ=this.options.clipz;this.updateClipping(true)}if(this.options.tracks&&this.geo_manager&&this.geo_manager.fTracks){this.addExtra(this.geo_manager.fTracks,"<prnt>/Tracks")}}if(this.options.transparancy!==0){this.changeGlobalTransparancy(this.options.transparancy,true)}this.completeScene();if(this.options._axis){this.toggleAxisDraw(true)}this._scene.overrideMaterial=null;this.getExtrasContainer("delete");var f=(this._main_painter?this._main_painter._extraObjects:null)||this._extraObjects;this.drawExtras(f);this.Render3D(0,true);if(d){a.progress()}this.addOrbitControls();this.addTransformControl();if(e){if(this.options.highlight===false){this.options.highlight=(this.first_render_tm<1000)}if(this._webgl&&this.options.autoRotate&&!this.options.project){this.autorotate(2.5)}if(!this._usesvg&&this.options.show_controls){this.showControlOptions(true)}this.DrawingReady()}if(this._draw_nodes_again){return this.startDrawGeometry()}this._drawing_ready=true};a.TGeoPainter.prototype.Cleanup=function(g){if(!g){this.AccessTopPainter(false);this.helpText();a.Painter.DisposeThreejsObject(this._scene);a.Painter.DisposeThreejsObject(this._full_geom);if(this._tcontrols){this._tcontrols.dispose()}if(this._controls){this._controls.Cleanup()}if(this._context_menu){this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,false)}if(this._datgui){this._datgui.destroy()}if(this._worker){this._worker.terminate()}a.TObjectPainter.prototype.Cleanup.call(this);delete this.options;delete this._animating;var f=this.GetGeometry();if(f&&this.options.is_main){if(f.$geo_painter===this){delete f.$geo_painter}else{if(f.fVolume&&f.fVolume.$geo_painter===this){delete f.fVolume.$geo_painter}}}if(this._main_painter){var h=this._main_painter._slave_painters.indexOf(this);if(h>=0){this._main_painter._slave_painters.splice(h,1)}}for(var e=0;e<this._slave_painters.length;++e){var d=this._slave_painters[e];if(d&&(d._main_painter===this)){d._main_painter=null}}}for(var e in this._slave_painters){var d=this._slave_painters[e];d._main_painter=null;if(d._clones===this._clones){d._clones=null}}this._main_painter=null;this._slave_painters=[];if(this._renderer){if(this._renderer.dispose){this._renderer.dispose()}if(this._renderer.context){delete this._renderer.context}}delete this._scene;this._scene_width=0;this._scene_height=0;this._renderer=null;this._toplevel=null;this._full_geom=null;this._camera=null;this._selected_mesh=null;if(this._clones&&this._clones_owner){this._clones.Cleanup(this._draw_nodes,this._build_shapes)}delete this._clones;delete this._clones_owner;delete this._draw_nodes;delete this._drawing_ready;delete this._build_shapes;delete this._new_draw_nodes;this.first_render_tm=0;this.last_render_tm=2000;this.drawing_stage=0;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};a.TGeoPainter.prototype.helpText=function(d){a.progress(d)};a.TGeoPainter.prototype.CheckResize=function(d){var e=this.pad_painter();if(e){if(!e.CheckCanvasResize(d)){return false}}var f=this.size_for_3d();if((this._scene_width===f.width)&&(this._scene_height===f.height)){return false}if((f.width<10)||(f.height<10)){return}this._scene_width=f.width;this._scene_height=f.height;this._camera.aspect=this._scene_width/this._scene_height;this._camera.updateProjectionMatrix();this._renderer.setSize(this._scene_width,this._scene_height,!this._fit_main_area);this.Render3D();return true};a.TGeoPainter.prototype.ToggleEnlarge=function(){if(b.event){b.event.preventDefault();b.event.stopPropagation()}if(this.enlarge_main("toggle")){this.CheckResize()}};a.TGeoPainter.prototype.ownedByTransformControls=function(e){var d=e.parent;while(d&&!(d instanceof c.TransformControls)){d=d.parent}return(d&&(d instanceof c.TransformControls))};a.TGeoPainter.prototype.accessObjectWireFrame=function(e,d){if(!e.hasOwnProperty("material")||(e instanceof c.GridHelper)){return}if(this.ownedByTransformControls(e)){return}if((d!==undefined)&&e.stack){e.material.wireframe=d}return e.material.wireframe};a.TGeoPainter.prototype.changeWireFrame=function(f,e){var d=this;f.traverse(function(g){d.accessObjectWireFrame(g,e)});this.Render3D()};a.Painter.drawGeoObject=function(h,f,e){if(!f){return null}a.GEO.GradPerSegm=a.gStyle.GeoGradPerSegm;a.GEO.CompressComp=a.gStyle.GeoCompressComp;var d=null,g=false;if(("fShapeBits" in f)&&("fShapeId" in f)){d=f;f=null}else{if((f._typename==="TGeoVolumeAssembly")||(f._typename==="TGeoVolume")){d=f.fShape}else{if(f._typename==="TEveGeoShapeExtract"){d=f.fShape}else{if(f._typename==="TGeoManager"){a.GEO.SetBit(f.fMasterVolume,a.GEO.BITS.kVisThis,false);d=f.fMasterVolume.fShape;g=true}else{if("fVolume" in f){if(f.fVolume){d=f.fVolume.fShape}}else{f=null}}}}}if(e&&e.indexOf("comp")==0&&d&&(d._typename=="TGeoCompositeShape")&&d.fNode){e=e.substr(4);f=a.GEO.buildCompositeVolume(d)}if(!f&&d){f=a.extend(a.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:d,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:true})}if(!f){return this.DrawingReady()}a.extend(this,new a.TGeoPainter(f,g));this.SetDivId(h,5);this._usesvg=a.BatchMode;this._webgl=!this._usesvg&&a.Painter.TestWebGL();this.options=this.decodeOptions(e);if(this.options._yup===undefined){this.options._yup=this.svg_canvas().empty()}if(this.options.is_main&&!f.$geo_painter){f.$geo_painter=this}if(!this.options.is_main&&this.options.project&&f.$geo_painter){this._main_painter=f.$geo_painter;this._main_painter._slave_painters.push(this)}this.checkScript(this.options.script_name,this.prepareObjectDraw.bind(this));return this};a.Painter.drawGeometry=a.Painter.drawGeoObject;a.Painter.drawAxis3D=function(g,f,e){var d=new a.TObjectPainter(f);if(!("_main" in f)){d.SetDivId(g)}d.Draw3DAxis=function(){var h=this.main_painter();if(!h&&("_main" in this.GetObject())){h=this.GetObject()._main}if(!h||!h._toplevel){return console.warn("no geo object found for 3D axis drawing")}var i=new c.Box3().setFromObject(h._toplevel);this.xmin=i.min.x;this.xmax=i.max.x;this.ymin=i.min.y;this.ymax=i.max.y;this.zmin=i.min.z;this.zmax=i.max.z;this.size_xy3d=this.size_z3d=0;this.DrawXYZ=a.Painter.HPainter_DrawXYZ;this.DrawXYZ(h._toplevel);h.adjustCameraPosition();h.TestAxisVisibility=a.Painter.HPainter_TestAxisVisibility;h.Render3D()};d.Draw3DAxis();return d.DrawingReady()};a.GEO.buildCompositeVolume=function(f,h){var g=a.Create("TGeoVolume");if(h&&(f._typename!=="TGeoCompositeShape")){g.fName=h;a.GEO.SetBit(g,a.GEO.BITS.kVisThis,true);g.fLineColor=(h=="Left"?2:3);g.fShape=f;return g}a.GEO.SetBit(g,a.GEO.BITS.kVisDaughters,true);g.$geoh=true;g.fName="";var e=a.Create("TGeoNodeMatrix");e.fName="Left";e.fMatrix=f.fNode.fLeftMat;e.fVolume=a.GEO.buildCompositeVolume(f.fNode.fLeft,"Left");var d=a.Create("TGeoNodeMatrix");d.fName="Right";d.fMatrix=f.fNode.fRightMat;d.fVolume=a.GEO.buildCompositeVolume(f.fNode.fRight,"Right");g.fNodes=a.Create("TList");g.fNodes.Add(e);g.fNodes.Add(d);return g};a.GEO.provideVisStyle=function(f){if(f._typename==="TEveGeoShapeExtract"){return f.fRnrSelf?" geovis_this":""}var e=!a.GEO.TestBit(f,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(f,a.GEO.BITS.kVisThis);var d=a.GEO.TestBit(f,a.GEO.BITS.kVisDaughters)||a.GEO.TestBit(f,a.GEO.BITS.kVisOneLevel);if(d&&(!f.fNodes||(f.fNodes.arr.length===0))){d=false}if(e&&d){return" geovis_all"}if(e){return" geovis_this"}if(d){return" geovis_daughters"}return""};a.GEO.getBrowserItem=function(d,f,e){if(d._geoobj){d._geoobj.$geoh=true}a.CallBack(e,d,d._geoobj)};a.GEO.createItem=function(i,k,e){var g={_kind:"ROOT."+k._typename,_name:e?e:a.GEO.ObjectName(k),_title:k.fTitle,_parent:i,_geoobj:k,_get:a.GEO.getBrowserItem};var h,d,j,f=false;if(k._typename=="TGeoMaterial"){g._icon="img_geomaterial"}else{if(k._typename=="TGeoMedium"){g._icon="img_geomedium"}else{if(k._typename=="TGeoMixture"){g._icon="img_geomixture"}else{if((k._typename.indexOf("TGeoNode")===0)&&k.fVolume){g._title="node:"+k._typename;if(k.fTitle.length>0){g._title+=" "+k.fTitle}h=k.fVolume}else{if(k._typename.indexOf("TGeoVolume")===0){h=k}else{if(k._typename=="TEveGeoShapeExtract"){f=true;d=k.fShape;j=k.fElements?k.fElements.arr:null}else{if((k.fShapeBits!==undefined)&&(k.fShapeId!==undefined)){d=k}}}}}}}if(h){d=h.fShape;j=h.fNodes?h.fNodes.arr:null}if(h||d||j){if(h){g._volume=h}if(j){g._more=true;g._expand=a.GEO.expandObject}else{if(d&&(d._typename==="TGeoCompositeShape")&&d.fNode){g._more=true;g._shape=d;g._expand=function(l,m){a.GEO.createItem(l,l._shape.fNode.fLeft,"Left");a.GEO.createItem(l,l._shape.fNode.fRight,"Right");return true}}}if(!g._title&&(k._typename!="TGeoVolume")){g._title=k._typename}if(d){if(g._title==""){g._title=d._typename}g._icon=a.GEO.getShapeIcon(d)}else{g._icon=g._more?"img_geocombi":"img_geobbox"}if(h){g._icon+=a.GEO.provideVisStyle(h)}else{if(f){g._icon+=a.GEO.provideVisStyle(k)}}g._menu=a.GEO.provideMenu;g._icon_click=a.GEO.browserIconClick}if(!i._childs){i._childs=[]}if(!g._name){if(typeof i._name==="string"){g._name=i._name;if(g._name.lastIndexOf("s")===g._name.length-1){g._name=g._name.substr(0,g._name.length-1)}g._name+="_"+i._childs.length}else{g._name="item_"+i._childs.length}}i._childs.push(g);return g};a.GEO.createList=function(f,d,e,h){if((d==null)||!("arr" in d)||(d.arr.length==0)){return}var g={_name:e,_kind:"ROOT.TList",_title:h,_more:true,_geoobj:d,_parent:f};g._get=function(i,k,j){if("_geoobj" in i){return a.CallBack(j,i,i._geoobj)}a.CallBack(j,i,null)};g._expand=function(j,i){if("fVolume" in i){i=i.fVolume.fNodes}if(!("arr" in i)){return false}j._childs=[];a.GEO.CheckDuplicates(null,i.arr);for(var k in i.arr){a.GEO.createItem(j,i.arr[k])}return true};if(!f._childs){f._childs=[]}f._childs.push(g)};a.GEO.provideMenu=function(d,l,e){if(!l._geoobj){return false}var h=l._geoobj,f=l._volume,g=(h._typename==="TEveGeoShapeExtract");if(!f&&!g){return false}d.add("separator");function m(q,p,o){if(!p){p={visible:0,hidden:0}}if(!o){if(p.assign!==undefined){q.fRnrSelf=p.assign}else{if(q.fRnrSelf){p.vis++}else{p.hidden++}}}if(q.fElements){for(var r=0;r<q.fElements.arr.length;++r){m(q.fElements.arr[r],p,false)}}return p}function i(n){if(n==="self"){h.fRnrSelf=!h.fRnrSelf;l._icon=l._icon.split(" ")[0]+a.GEO.provideVisStyle(h);e.UpdateTreeNode(l)}else{m(h,{assign:(n==="true")},true);e.ForEach(function(o){if(o._geoobj&&o._icon){o._icon=l._icon.split(" ")[0]+a.GEO.provideVisStyle(o._geoobj);e.UpdateTreeNode(o)}},l)}a.GEO.findItemWithPainter(l,"testGeomChanges")}function k(n){a.GEO.ToggleBit(f,n);var o=l._icon.split(" ")[0]+a.GEO.provideVisStyle(f);e.ForEach(function(p){if(l._volume===p._volume){p._icon=o;e.UpdateTreeNode(p)}});e.UpdateTreeNode(l);a.GEO.findItemWithPainter(l,"testGeomChanges")}if((l._geoobj._typename.indexOf("TGeoNode")===0)&&a.GEO.findItemWithPainter(l)){d.add("Focus",function(){var o=a.GEO.findItemWithPainter(l);if(!o){return}var n=e.itemFullName(l,o);if(o._painter&&typeof o._painter.focusOnItem=="function"){o._painter.focusOnItem(n)}})}if(g){d.addchk(h.fRnrSelf,"Visible","self",i);var j=m(h,undefined,true);if(j.hidden+j.visible>0){d.addchk((j.hidden==0),"Daughters",(j.hidden!=0)?"true":"false",i)}}else{d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisNone),"Invisible",a.GEO.BITS.kVisNone,k);d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisThis),"Visible",a.GEO.BITS.kVisThis,k);d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisDaughters),"Daughters",a.GEO.BITS.kVisDaughters,k);d.addchk(a.GEO.TestBit(f,a.GEO.BITS.kVisOneLevel),"1lvl daughters",a.GEO.BITS.kVisOneLevel,k)}return true};a.GEO.findItemWithPainter=function(e,d){while(e){if(e._painter&&e._painter._camera){if(d&&typeof e._painter[d]=="function"){e._painter[d]()}return e}e=e._parent}return null};a.GEO.updateBrowserIcons=function(e,d){if(!e||!d){return}d.ForEach(function(f){if((e===f._volume)||(e===f._geoobj)){f._icon=f._icon.split(" ")[0]+a.GEO.provideVisStyle(e);d.UpdateTreeNode(f)}})};a.GEO.browserIconClick=function(e,g){if(e._volume){if(e._more&&e._volume.fNodes&&(e._volume.fNodes.arr.length>0)){a.GEO.ToggleBit(e._volume,a.GEO.BITS.kVisDaughters)}else{a.GEO.ToggleBit(e._volume,a.GEO.BITS.kVisThis)}a.GEO.updateBrowserIcons(e._volume,g);a.GEO.findItemWithPainter(e,"testGeomChanges");return false}if(e._geoobj&&e._geoobj._typename=="TEveGeoShapeExtract"){e._geoobj.fRnrSelf=!e._geoobj.fRnrSelf;a.GEO.updateBrowserIcons(e._geoobj,g);a.GEO.findItemWithPainter(e,"testGeomChanges");return false}var f=a.GEO.findItemWithPainter(e);if(!f){return false}var d=f._painter.ExtraObjectVisible(g,e,true);return(d!==undefined)?true:false};a.GEO.getShapeIcon=function(d){switch(d._typename){case"TGeoArb8":return"img_geoarb8";break;case"TGeoCone":return"img_geocone";break;case"TGeoConeSeg":return"img_geoconeseg";break;case"TGeoCompositeShape":return"img_geocomposite";break;case"TGeoTube":return"img_geotube";break;case"TGeoTubeSeg":return"img_geotubeseg";break;case"TGeoPara":return"img_geopara";break;case"TGeoParaboloid":return"img_geoparab";break;case"TGeoPcon":return"img_geopcon";break;case"TGeoPgon":return"img_geopgon";break;case"TGeoShapeAssembly":return"img_geoassembly";break;case"TGeoSphere":return"img_geosphere";break;case"TGeoTorus":return"img_geotorus";break;case"TGeoTrd1":return"img_geotrd1";break;case"TGeoTrd2":return"img_geotrd2";break;case"TGeoXtru":return"img_geoxtru";break;case"TGeoTrap":return"img_geotrap";break;case"TGeoGtra":return"img_geogtra";break;case"TGeoEltu":return"img_geoeltu";break;case"TGeoHype":return"img_geohype";break;case"TGeoCtub":return"img_geoctub";break}return"img_geotube"};a.GEO.getBrowserIcon=function(d,g){var e="";if(d._kind=="ROOT.TEveTrack"){e="img_evetrack"}else{if(d._kind=="ROOT.TEvePointSet"){e="img_evepoints"}else{if(d._kind=="ROOT.TPolyMarker3D"){e="img_evepoints"}}}if(e.length>0){var f=a.GEO.findItemWithPainter(d);if(f){if(f._painter.ExtraObjectVisible(g,d)){e+=" geovis_this"}}}return e};a.GEO.expandObject=function(n,j){if(!n||!j){return false}var k=(j._typename.indexOf("TGeoNode")===0),e=(j._typename.indexOf("TGeoVolume")===0),f=(j._typename==="TGeoManager"),g=(j._typename==="TEveGeoShapeExtract");if(!k&&!e&&!f&&!g){return false}if(n._childs){return true}if(f){a.GEO.createList(n,j.fMaterials,"Materials","list of materials");a.GEO.createList(n,j.fMedia,"Media","list of media");a.GEO.createList(n,j.fTracks,"Tracks","list of tracks");a.GEO.SetBit(j.fMasterVolume,a.GEO.BITS.kVisThis,false);a.GEO.createItem(n,j.fMasterVolume);return true}var l,d,m;if(g){d=j.fElements?j.fElements.arr:null;m=j.fShape}else{l=(k?j.fVolume:j);d=l&&l.fNodes?l.fNodes.arr:null;m=l?l.fShape:null}if(!d&&m&&(m._typename==="TGeoCompositeShape")&&m.fNode){if(!n._childs){a.GEO.createItem(n,m.fNode.fLeft,"Left");a.GEO.createItem(n,m.fNode.fRight,"Right")}return true}if(!d){return false}a.GEO.CheckDuplicates(j,d);for(var h=0;h<d.length;++h){a.GEO.createItem(n,d[h])}return true};a.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:a.Painter.drawGeoObject,expand:a.GEO.expandObject,opt:";more;all;count"});a.addDrawFunc({name:"TAxis3D",func:a.Painter.drawAxis3D});a.addDrawFunc({name:"TEvePointSet",icon_get:a.GEO.getBrowserIcon,icon_click:a.GEO.browserIconClick});a.addDrawFunc({name:"TEveTrack",icon_get:a.GEO.getBrowserIcon,icon_click:a.GEO.browserIconClick});return a.Painter}));